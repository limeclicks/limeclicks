{% extends 'dashboard_base.html' %}

{% block page_title %}Issues - {{ audit.project.domain }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <div class="breadcrumbs text-sm">
            <ul>
                <li><a href="{% url 'site_audit:list' %}">Site Audits</a></li>
                <li><a href="{% url 'site_audit:detail' audit.id %}">{{ audit.project.domain }}</a></li>
                <li>Issues</li>
            </ul>
        </div>
        
        <div class="flex justify-between items-start mt-4">
            <div>
                <h1 class="text-2xl font-bold">Site Issues</h1>
                <p class="text-base-content/60 mt-1">{{ audit.project.domain }} - {{ total_issues }} total issues found</p>
            </div>
            
            <div class="flex gap-2">
                <button class="btn btn-sm" onclick="exportIssues()">
                    <i class="fas fa-download"></i> Export CSV
                </button>
                <a href="{% url 'site_audit:detail' audit.id %}" class="btn btn-primary btn-sm">
                    <i class="fas fa-chart-line"></i> View Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card bg-base-100 shadow-sm mb-6">
        <div class="card-body">
            <form method="get" class="flex flex-wrap gap-4">
                <!-- Issue Type Filter -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text text-xs">Issue Type</span>
                    </label>
                    <select name="type" class="select select-bordered select-sm">
                        <option value="">All Types</option>
                        <option value="broken_link" {% if issue_type == 'broken_link' %}selected{% endif %}>Broken Links</option>
                        <option value="missing_title" {% if issue_type == 'missing_title' %}selected{% endif %}>Missing Title</option>
                        <option value="duplicate_title" {% if issue_type == 'duplicate_title' %}selected{% endif %}>Duplicate Title</option>
                        <option value="missing_meta" {% if issue_type == 'missing_meta' %}selected{% endif %}>Missing Meta Description</option>
                        <option value="duplicate_meta" {% if issue_type == 'duplicate_meta' %}selected{% endif %}>Duplicate Meta Description</option>
                        <option value="long_url" {% if issue_type == 'long_url' %}selected{% endif %}>Long URL</option>
                        <option value="missing_h1" {% if issue_type == 'missing_h1' %}selected{% endif %}>Missing H1</option>
                        <option value="multiple_h1" {% if issue_type == 'multiple_h1' %}selected{% endif %}>Multiple H1</option>
                        <option value="missing_alt" {% if issue_type == 'missing_alt' %}selected{% endif %}>Missing Alt Text</option>
                    </select>
                </div>
                
                <!-- Severity Filter -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text text-xs">Severity</span>
                    </label>
                    <select name="severity" class="select select-bordered select-sm">
                        <option value="">All Severities</option>
                        <option value="critical" {% if severity == 'critical' %}selected{% endif %}>Critical</option>
                        <option value="high" {% if severity == 'high' %}selected{% endif %}>High</option>
                        <option value="medium" {% if severity == 'medium' %}selected{% endif %}>Medium</option>
                        <option value="low" {% if severity == 'low' %}selected{% endif %}>Low</option>
                    </select>
                </div>
                
                <!-- Apply/Clear Buttons -->
                <div class="form-control justify-end">
                    <div class="flex gap-2">
                        <button type="submit" class="btn btn-primary btn-sm">
                            <i class="fas fa-filter"></i> Apply Filters
                        </button>
                        {% if issue_type or severity %}
                        <a href="{% url 'site_audit:issues' audit.id %}" class="btn btn-ghost btn-sm">
                            Clear
                        </a>
                        {% endif %}
                    </div>
                </div>
            </form>
            
            <!-- Issue Type Counts -->
            {% if issue_counts %}
            <div class="flex flex-wrap gap-2 mt-4">
                {% for count_item in issue_counts %}
                <div class="badge badge-outline">
                    {{ count_item.issue_type|title|cut:"_" }}: {{ count_item.count }}
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Issues Table -->
    <div class="card bg-base-100 shadow-sm">
        <div class="card-body p-0">
            {% if page_obj.object_list %}
            <div class="overflow-x-auto">
                <table class="table table-zebra">
                    <thead>
                        <tr class="border-b-2 border-base-300">
                            <th class="text-xs font-semibold uppercase tracking-wider">Severity</th>
                            <th class="text-xs font-semibold uppercase tracking-wider">Issue Type</th>
                            <th class="text-xs font-semibold uppercase tracking-wider">Page URL</th>
                            <th class="text-xs font-semibold uppercase tracking-wider">Description</th>
                            <th class="text-xs font-semibold uppercase tracking-wider">Status Code</th>
                            <th class="text-xs font-semibold uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for issue in page_obj.object_list %}
                        <tr class="hover">
                            <!-- Severity -->
                            <td>
                                {% if issue.severity == 'critical' %}
                                <span class="badge badge-error">Critical</span>
                                {% elif issue.severity == 'high' %}
                                <span class="badge badge-warning">High</span>
                                {% elif issue.severity == 'medium' %}
                                <span class="badge badge-info">Medium</span>
                                {% else %}
                                <span class="badge badge-ghost">Low</span>
                                {% endif %}
                            </td>
                            
                            <!-- Issue Type -->
                            <td>
                                <div class="flex items-center gap-2">
                                    {% if 'broken' in issue.issue_type %}
                                    <i class="fas fa-link-slash text-error"></i>
                                    {% elif 'title' in issue.issue_type %}
                                    <i class="fas fa-heading text-warning"></i>
                                    {% elif 'meta' in issue.issue_type %}
                                    <i class="fas fa-file-alt text-info"></i>
                                    {% elif 'h1' in issue.issue_type %}
                                    <i class="fas fa-heading text-warning"></i>
                                    {% elif 'alt' in issue.issue_type %}
                                    <i class="fas fa-image text-info"></i>
                                    {% else %}
                                    <i class="fas fa-exclamation-circle text-base-content/60"></i>
                                    {% endif %}
                                    <span class="text-sm">{{ issue.issue_type|title|cut:"_" }}</span>
                                </div>
                            </td>
                            
                            <!-- Page URL -->
                            <td>
                                <div class="max-w-xs truncate">
                                    <a href="{{ issue.page_url }}" target="_blank" 
                                       class="link link-hover text-sm" 
                                       title="{{ issue.page_url }}">
                                        {{ issue.page_url|truncatechars:50 }}
                                    </a>
                                </div>
                            </td>
                            
                            <!-- Description -->
                            <td>
                                <div class="max-w-md">
                                    <p class="text-sm">{{ issue.description|default:"" }}</p>
                                    {% if issue.recommendation %}
                                    <div class="text-xs text-base-content/60 mt-1">
                                        <i class="fas fa-lightbulb"></i> {{ issue.recommendation }}
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                            
                            <!-- Status Code -->
                            <td>
                                {% if issue.http_status_code %}
                                <span class="badge badge-sm 
                                    {% if issue.http_status_code >= 400 %}badge-error
                                    {% elif issue.http_status_code >= 300 %}badge-warning
                                    {% else %}badge-success{% endif %}">
                                    {{ issue.http_status_code }}
                                </span>
                                {% else %}
                                <span class="text-base-content/40">-</span>
                                {% endif %}
                            </td>
                            
                            <!-- Actions -->
                            <td>
                                <div class="dropdown dropdown-end">
                                    <label tabindex="0" class="btn btn-ghost btn-xs">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </label>
                                    <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow-lg bg-base-100 rounded-box w-52 border">
                                        <li>
                                            <a href="{{ issue.page_url }}" target="_blank">
                                                <i class="fas fa-external-link-alt"></i> Visit Page
                                            </a>
                                        </li>
                                        <li>
                                            <button onclick="copyToClipboard('{{ issue.page_url }}')">
                                                <i class="fas fa-copy"></i> Copy URL
                                            </button>
                                        </li>
                                        {% if issue.source_url %}
                                        <li>
                                            <a href="{{ issue.source_url }}" target="_blank">
                                                <i class="fas fa-code"></i> View Source
                                            </a>
                                        </li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
            <div class="card-footer p-4 border-t border-base-300">
                <div class="flex justify-between items-center">
                    <div class="text-sm text-base-content/60">
                        Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} issues
                    </div>
                    <div class="btn-group">
                        {% if page_obj.has_previous %}
                        <a href="?page={{ page_obj.previous_page_number }}{% if issue_type %}&type={{ issue_type }}{% endif %}{% if severity %}&severity={{ severity }}{% endif %}" 
                           class="btn btn-sm">«</a>
                        {% endif %}
                        
                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                            <button class="btn btn-sm btn-active">{{ num }}</button>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <a href="?page={{ num }}{% if issue_type %}&type={{ issue_type }}{% endif %}{% if severity %}&severity={{ severity }}{% endif %}" 
                               class="btn btn-sm">{{ num }}</a>
                            {% endif %}
                        {% endfor %}
                        
                        {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}{% if issue_type %}&type={{ issue_type }}{% endif %}{% if severity %}&severity={{ severity }}{% endif %}" 
                           class="btn btn-sm">»</a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% else %}
            <!-- Empty State -->
            <div class="p-12 text-center">
                <i class="fas fa-check-circle text-6xl text-success mb-4"></i>
                <h3 class="text-xl font-semibold mb-2">No Issues Found</h3>
                <p class="text-base-content/60">
                    {% if issue_type or severity %}
                    No issues match your current filters.
                    {% else %}
                    Great! No issues were detected in the latest audit.
                    {% endif %}
                </p>
                {% if issue_type or severity %}
                <a href="{% url 'site_audit:issues' audit.id %}" class="btn btn-primary mt-4">
                    Clear Filters
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        // Show toast
        const toast = document.createElement('div');
        toast.className = 'toast toast-top toast-end';
        toast.innerHTML = `
            <div class="alert alert-success">
                <i class="fas fa-check"></i>
                <span>URL copied to clipboard</span>
            </div>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    });
}

function exportIssues() {
    // Implement CSV export
    const params = new URLSearchParams(window.location.search);
    params.append('export', 'csv');
    window.location.href = window.location.pathname + '?' + params.toString();
}
</script>
{% endblock %}