<!-- Issues List -->
<div class="space-y-4">
    {% for issue in page_obj %}
    <div class="card bg-white shadow-md hover:shadow-lg transition-shadow">
        <div class="card-body">
            <div class="flex items-start justify-between gap-4">
                <div class="flex-1">
                    <!-- Issue Header -->
                    <div class="flex items-start gap-3 mb-3">
                        <!-- Severity Indicator -->
                        <div class="mt-1">
                            {% if issue.severity == 'critical' %}
                                <div class="w-3 h-3 rounded-full bg-error animate-pulse"></div>
                            {% elif issue.severity == 'high' %}
                                <div class="w-3 h-3 rounded-full bg-warning"></div>
                            {% elif issue.severity == 'medium' %}
                                <div class="w-3 h-3 rounded-full bg-info"></div>
                            {% elif issue.severity == 'low' %}
                                <div class="w-3 h-3 rounded-full bg-primary"></div>
                            {% else %}
                                <div class="w-3 h-3 rounded-full bg-base-content/20"></div>
                            {% endif %}
                        </div>
                        
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                {% if issue.severity == 'critical' %}
                                    <span class="badge badge-error">Critical</span>
                                {% elif issue.severity == 'high' %}
                                    <span class="badge badge-warning">High</span>
                                {% elif issue.severity == 'medium' %}
                                    <span class="badge badge-info">Medium</span>
                                {% elif issue.severity == 'low' %}
                                    <span class="badge badge-primary">Low</span>
                                {% else %}
                                    <span class="badge badge-ghost">Info</span>
                                {% endif %}
                                <h4 class="text-lg font-bold">{{ issue.get_clean_display_name }}</h4>
                            </div>
                            
                            <p class="text-sm text-base-content/80 mb-3 leading-relaxed">
                                {{ issue.description }}
                            </p>
                            
                            <div class="flex items-center gap-2 text-xs text-base-content/60 bg-base-100 rounded-lg p-2">
                                <i class="fas fa-globe text-primary"></i>
                                <a href="{{ issue.page_url }}" target="_blank" class="link link-primary hover:link-hover truncate">
                                    {{ issue.page_url|truncatechars:100 }}
                                </a>
                            </div>
                            
                            <!-- Resolution (Initially Hidden) -->
                            <div id="resolution-{{ issue.id }}" class="hidden mt-4">
                                <div class="divider"></div>
                                <div class="bg-success/10 rounded-xl p-4 border border-success/20">
                                    <h5 class="font-bold text-sm mb-3 text-success flex items-center gap-2">
                                        <i class="fas fa-tools"></i>
                                        How to Fix This Issue:
                                    </h5>
                                    <p class="text-sm text-base-content/80 whitespace-pre-line leading-relaxed">{{ issue.recommendation }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Button -->
                <div class="flex flex-col gap-2">
                    <button onclick="toggleResolution('{{ issue.id }}')" 
                            class="btn btn-circle btn-sm btn-primary shadow-lg"
                            title="Show solution">
                        <i class="fas fa-wrench"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="card bg-white shadow-lg border-2 border-success/20">
        <div class="card-body text-center py-16">
            <div class="w-24 h-24 mx-auto mb-6 rounded-full bg-gradient-to-br from-success/20 to-success/10 flex items-center justify-center shadow-lg">
                <i class="fas fa-trophy text-4xl text-success animate-bounce"></i>
            </div>
            <h3 class="text-2xl font-bold mb-3 text-success">Perfect Score! ðŸŽ‰</h3>
            <p class="text-base-content/70 text-lg">Your site is looking fantastic with no SEO issues detected.</p>
            <div class="mt-6">
                <div class="badge badge-success badge-lg gap-2">
                    <i class="fas fa-check-circle"></i>
                    All Clear
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Pagination Controls -->
{% if page_obj.has_other_pages or total_issues > 25 %}
<div class="card bg-white shadow-md mt-6">
    <div class="card-body p-4">
        <div class="flex flex-col md:flex-row items-center justify-between gap-4">
            <!-- Results Per Page Selector -->
            <div class="flex items-center gap-2">
                <span class="text-sm font-semibold">Show:</span>
                <select class="select select-bordered select-sm bg-white"
                        hx-get="/site-audit/{{ audit.id }}/issues/load-more/"
                        hx-target="#issues-container"
                        hx-swap="innerHTML"
                        hx-trigger="change"
                        hx-include="[name='severity'], [name='search']"
                        hx-indicator="#loading-spinner"
                        name="per_page">
                    <option value="25" {% if per_page == 25 %}selected{% endif %}>25 per page</option>
                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50 per page</option>
                    <option value="100" {% if per_page == 100 %}selected{% endif %}>100 per page</option>
                </select>
                <span class="text-xs text-base-content/60">
                    Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }} issues
                </span>
            </div>
            
            <!-- Page Navigation -->
            <div class="join">
                {% if page_obj.has_previous %}
                <button class="join-item btn btn-sm"
                        hx-get="/site-audit/{{ audit.id }}/issues/load-more/?page={{ page_obj.previous_page_number }}&severity={{ severity_filter }}&issue_type={{ issue_type_filter }}&search={{ search_query }}&per_page={{ per_page }}"
                        hx-target="#issues-container"
                        hx-swap="innerHTML"
                        hx-indicator="#loading-spinner">
                    <i class="fas fa-chevron-left"></i>
                </button>
                {% else %}
                <button class="join-item btn btn-sm btn-disabled">
                    <i class="fas fa-chevron-left"></i>
                </button>
                {% endif %}
                
                <!-- Page Numbers with ellipsis -->
                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <button class="join-item btn btn-sm btn-primary">{{ num }}</button>
                    {% elif num == 1 or num == page_obj.paginator.num_pages %}
                        <button class="join-item btn btn-sm"
                                hx-get="/site-audit/{{ audit.id }}/issues/load-more/?page={{ num }}&severity={{ severity_filter }}&issue_type={{ issue_type_filter }}&search={{ search_query }}&per_page={{ per_page }}"
                                hx-target="#issues-container"
                                hx-swap="innerHTML"
                                hx-indicator="#loading-spinner">
                            {{ num }}
                        </button>
                    {% elif num > page_obj.number|add:'-2' and num < page_obj.number|add:'2' %}
                        <button class="join-item btn btn-sm"
                                hx-get="/site-audit/{{ audit.id }}/issues/load-more/?page={{ num }}&severity={{ severity_filter }}&issue_type={{ issue_type_filter }}&search={{ search_query }}&per_page={{ per_page }}"
                                hx-target="#issues-container"
                                hx-swap="innerHTML"
                                hx-indicator="#loading-spinner">
                            {{ num }}
                        </button>
                    {% elif num == page_obj.number|add:'-3' or num == page_obj.number|add:'3' %}
                        <button class="join-item btn btn-sm btn-disabled">...</button>
                    {% endif %}
                {% endfor %}
                
                {% if page_obj.has_next %}
                <button class="join-item btn btn-sm"
                        hx-get="/site-audit/{{ audit.id }}/issues/load-more/?page={{ page_obj.next_page_number }}&severity={{ severity_filter }}&issue_type={{ issue_type_filter }}&search={{ search_query }}&per_page={{ per_page }}"
                        hx-target="#issues-container"
                        hx-swap="innerHTML"
                        hx-indicator="#loading-spinner">
                    <i class="fas fa-chevron-right"></i>
                </button>
                {% else %}
                <button class="join-item btn btn-sm btn-disabled">
                    <i class="fas fa-chevron-right"></i>
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endif %}

<!-- Loading Spinner -->
<div id="loading-spinner" class="htmx-indicator text-center py-4">
    <span class="loading loading-spinner loading-md"></span>
</div>

<script>
// Use window functions if available (defined in main page), otherwise define locally
if (typeof window.toggleResolution === 'undefined') {
    window.toggleResolution = function(issueId) {
        const resolution = document.getElementById(`resolution-${issueId}`);
        if (resolution) {
            resolution.classList.toggle('hidden');
        }
    }
}
</script>