<!-- Performance Tab Content with Desktop/Mobile Sub-tabs -->
<div class="space-y-6">
    <!-- Performance Sub-tabs -->
    <div class="tabs tabs-boxed bg-base-100 border border-base-300">
        <button class="tab tab-active" 
                id="mobile-tab-btn"
                onclick="showPerformanceTab('mobile', this)">
            <i class="fas fa-mobile-alt mr-2"></i>
            Mobile
        </button>
        <button class="tab" 
                id="desktop-tab-btn"
                onclick="showPerformanceTab('desktop', this)">
            <i class="fas fa-desktop mr-2"></i>
            Desktop
        </button>
    </div>

    <!-- Mobile Performance Content -->
    <div id="mobile-performance-content" class="performance-content" data-url="{% if mobile_pagespeed_url %}{{ mobile_pagespeed_url }}{% endif %}">
        <div class="loading-container">
            <div class="flex flex-col items-center justify-center py-16">
                <div class="performance-loader mb-6">
                    <div class="loader-circle"></div>
                    <div class="loader-circle"></div>
                    <div class="loader-circle"></div>
                    <div class="loader-circle"></div>
                    <i class="fas fa-mobile-alt loader-icon"></i>
                </div>
                <h3 class="text-lg font-semibold text-base-content mb-2">Analyzing Mobile Performance</h3>
                <p class="text-sm text-base-content/60">Loading PageSpeed Insights data...</p>
                <div class="flex items-center gap-2 mt-4">
                    <span class="loading loading-dots loading-sm text-primary"></span>
                    <span class="text-xs text-base-content/40">This may take a few seconds</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Desktop Performance Content -->
    <div id="desktop-performance-content" class="performance-content hidden" data-url="{% if desktop_pagespeed_url %}{{ desktop_pagespeed_url }}{% endif %}">
        <div class="loading-container">
            <div class="flex flex-col items-center justify-center py-16">
                <div class="performance-loader mb-6">
                    <div class="loader-circle"></div>
                    <div class="loader-circle"></div>
                    <div class="loader-circle"></div>
                    <div class="loader-circle"></div>
                    <i class="fas fa-desktop loader-icon"></i>
                </div>
                <h3 class="text-lg font-semibold text-base-content mb-2">Analyzing Desktop Performance</h3>
                <p class="text-sm text-base-content/60">Loading PageSpeed Insights data...</p>
                <div class="flex items-center gap-2 mt-4">
                    <span class="loading loading-dots loading-sm text-primary"></span>
                    <span class="text-xs text-base-content/40">This may take a few seconds</span>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Modern Performance Loader */
    .performance-loader {
        position: relative;
        width: 100px;
        height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .loader-circle {
        position: absolute;
        width: 100%;
        height: 100%;
        border: 3px solid transparent;
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 2s linear infinite;
    }
    
    .loader-circle:nth-child(1) {
        width: 100%;
        height: 100%;
        animation-duration: 2s;
        border-top-color: #667eea;
        opacity: 0.8;
    }
    
    .loader-circle:nth-child(2) {
        width: 85%;
        height: 85%;
        animation-duration: 1.75s;
        border-top-color: #764ba2;
        animation-direction: reverse;
        opacity: 0.6;
    }
    
    .loader-circle:nth-child(3) {
        width: 70%;
        height: 70%;
        animation-duration: 1.5s;
        border-top-color: #f59e0b;
        opacity: 0.4;
    }
    
    .loader-circle:nth-child(4) {
        width: 55%;
        height: 55%;
        animation-duration: 1.25s;
        border-top-color: #10b981;
        animation-direction: reverse;
        opacity: 0.3;
    }
    
    .loader-icon {
        font-size: 24px;
        color: #667eea;
        z-index: 10;
        animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes spin {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(360deg);
        }
    }
    
    @keyframes pulse {
        0%, 100% {
            transform: scale(1);
            opacity: 1;
        }
        50% {
            transform: scale(1.1);
            opacity: 0.7;
        }
    }
    
    .loading-container {
        min-height: 400px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 12px;
        position: relative;
        overflow: hidden;
    }
    
    .loading-container::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(
            45deg,
            transparent,
            rgba(255, 255, 255, 0.1),
            transparent
        );
        animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
        0% {
            transform: translateX(-100%) translateY(-100%) rotate(45deg);
        }
        100% {
            transform: translateX(100%) translateY(100%) rotate(45deg);
        }
    }
    
    .metric-card {
        background: white;
        border-radius: 8px;
        padding: 16px;
        border: 1px solid #e5e7eb;
        transition: all 0.3s ease;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .score-circle {
        width: 80px;
        height: 80px;
        position: relative;
    }
    
    .score-circle svg {
        transform: rotate(-90deg);
    }
    
    .audit-item {
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 8px;
        border: 1px solid #e5e7eb;
        background: white;
    }
    
    .audit-item.passed {
        background: #f0fdf4;
        border-color: #86efac;
    }
    
    .audit-item.failed {
        background: #fef2f2;
        border-color: #fca5a5;
    }
    
    .audit-item.warning {
        background: #fefce8;
        border-color: #fde047;
    }
    
    .opportunity-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 12px;
    }
    
    .opportunity-card.high-impact {
        border-left: 4px solid #ef4444;
    }
    
    .opportunity-card.medium-impact {
        border-left: 4px solid #f59e0b;
    }
    
    .opportunity-card.low-impact {
        border-left: 4px solid #3b82f6;
    }
    
    /* Fix for collapse arrow positioning */
    .opportunity-card .collapse-arrow::after {
        position: absolute;
        right: 1.5rem;
        top: 50%;
        transform: translateY(-50%);
    }
    
    .opportunity-card .collapse-title {
        position: relative;
        padding-left: 1rem;
    }
    
    .diagnostic-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 12px;
        border-bottom: 1px solid #f3f4f6;
    }
    
    .diagnostic-item:last-child {
        border-bottom: none;
    }
</style>

<script>
    // Use window object to avoid redeclaration errors with HTMX
    if (typeof window.performanceDataCache === 'undefined') {
        window.performanceDataCache = {
            mobile: null,
            desktop: null
        };
    }

    // Load performance data when tab is opened
    // Use a small delay to ensure DOM is ready when loaded via HTMX
    setTimeout(function() {
        // Check if we're on the performance tab and load mobile data initially
        const mobileContent = document.getElementById('mobile-performance-content');
        if (mobileContent && !mobileContent.classList.contains('hidden')) {
            loadPerformanceData('mobile');
        }
    }, 100);

    window.showPerformanceTab = function(tabName, element) {
        // Update active tab styling
        document.querySelectorAll('#mobile-tab-btn, #desktop-tab-btn').forEach(tab => {
            tab.classList.remove('tab-active');
        });
        element.classList.add('tab-active');
        
        // Hide all performance content
        document.querySelectorAll('.performance-content').forEach(content => {
            content.classList.add('hidden');
        });
        
        // Show selected content
        const contentElement = document.getElementById(`${tabName}-performance-content`);
        contentElement.classList.remove('hidden');
        
        // Load data if not already loaded
        if (!window.performanceDataCache[tabName]) {
            loadPerformanceData(tabName);
        }
    }

    window.loadPerformanceData = async function(device) {
        const contentElement = document.getElementById(`${device}-performance-content`);
        const url = contentElement.dataset.url;
        
        console.log(`Loading ${device} performance data from URL:`, url);
        
        if (!url || url === 'None' || url === '') {
            contentElement.innerHTML = `
                <div class="card bg-base-100 shadow-sm border border-base-300">
                    <div class="card-body text-center py-12">
                        <i class="fas fa-${device === 'mobile' ? 'mobile-alt' : 'desktop'} text-5xl text-base-content/20 mb-4"></i>
                        <h3 class="text-xl font-semibold text-base-content mb-2">${device.charAt(0).toUpperCase() + device.slice(1)} Performance Data Not Available</h3>
                        <p class="text-base-content/60">PageSpeed Insights data for ${device} is not available for this audit.</p>
                        <p class="text-sm text-base-content/50 mt-2">Run a new audit to collect performance metrics.</p>
                    </div>
                </div>
            `;
            return;
        }
        
        try {
            const response = await fetch(url, {
                mode: 'cors',
                credentials: 'omit'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            window.performanceDataCache[device] = data;
            window.renderPerformanceData(device, data);
        } catch (error) {
            console.error(`Error loading ${device} performance data:`, error);
            
            // Check if it's a CORS error
            let errorMessage = error.message;
            let helpText = 'Please check the console for more details.';
            
            if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                errorMessage = 'Network or CORS error';
                helpText = `
                    <div class="mt-2">
                        <p class="font-semibold">Possible causes:</p>
                        <ul class="list-disc list-inside text-xs">
                            <li>CORS is not configured on the R2 bucket</li>
                            <li>The presigned URL has expired</li>
                            <li>Network connectivity issue</li>
                        </ul>
                        <p class="mt-2 text-xs">See R2_CORS_SETUP.md for configuration instructions.</p>
                    </div>
                `;
            }
            
            contentElement.innerHTML = `
                <div class="alert alert-error">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <h3 class="font-bold">Failed to load performance data</h3>
                        <div class="text-sm">Error: ${errorMessage}</div>
                        <div class="text-xs mt-1">${helpText}</div>
                    </div>
                </div>
            `;
        }
    }

    window.renderPerformanceData = function(device, data) {
        const contentElement = document.getElementById(`${device}-performance-content`);
        
        console.log(`Rendering ${device} performance data:`, data);
        
        // Handle the nested data structure from R2
        let pageSpeedData = data;
        if (data && data.data) {
            pageSpeedData = data.data;
        }
        
        if (!pageSpeedData || !pageSpeedData.lighthouseResult) {
            console.error('Invalid data structure:', pageSpeedData);
            contentElement.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Invalid performance data format.</span>
                </div>
            `;
            return;
        }

        const lighthouse = pageSpeedData.lighthouseResult;
        const categories = lighthouse.categories || {};
        const audits = lighthouse.audits || {};
        
        console.log('Categories found:', Object.keys(categories));
        console.log('Audits found:', Object.keys(audits).length);
        
        // Extract scores
        const performanceScore = Math.round((categories.performance?.score || 0) * 100);
        const accessibilityScore = Math.round((categories.accessibility?.score || 0) * 100);
        const bestPracticesScore = Math.round((categories['best-practices']?.score || 0) * 100);
        const seoScore = Math.round((categories.seo?.score || 0) * 100);
        
        // Extract metrics
        const metrics = {
            fcp: audits['first-contentful-paint']?.displayValue || 'N/A',
            lcp: audits['largest-contentful-paint']?.displayValue || 'N/A',
            cls: audits['cumulative-layout-shift']?.displayValue || 'N/A',
            si: audits['speed-index']?.displayValue || 'N/A',
            tti: audits['interactive']?.displayValue || 'N/A',
            tbt: audits['total-blocking-time']?.displayValue || 'N/A'
        };

        // Extract screenshots
        let finalScreenshot = null;
        let screenshotThumbnails = [];
        
        if (audits['final-screenshot'] && audits['final-screenshot'].details && audits['final-screenshot'].details.data) {
            finalScreenshot = audits['final-screenshot'].details.data;
        }
        
        if (audits['screenshot-thumbnails'] && audits['screenshot-thumbnails'].details && audits['screenshot-thumbnails'].details.items) {
            screenshotThumbnails = audits['screenshot-thumbnails'].details.items;
        }
        
        // Extract opportunities, diagnostics, and improvements
        const opportunities = [];
        const diagnostics = [];
        const improvements = [];
        
        Object.entries(audits).forEach(([key, audit]) => {
            // Skip if audit doesn't have required properties
            if (!audit || !audit.title) return;
            
            // Check for opportunities (audits with potential savings)
            if (audit.details && audit.details.type === 'opportunity' && audit.score !== null && audit.score < 1) {
                opportunities.push({
                    id: key,
                    title: audit.title,
                    description: audit.description || '',
                    displayValue: audit.displayValue || (audit.numericValue ? `${Math.round(audit.numericValue)} ms` : ''),
                    score: audit.score || 0,
                    impact: audit.details.overallSavingsMs || audit.numericValue || 0,
                    details: audit.details
                });
            } 
            // Check for failed audits with improvement suggestions
            else if (audit.score !== null && audit.score < 1 && !key.startsWith('screenshot') && !key.includes('insight')) {
                const item = {
                    id: key,
                    title: audit.title,
                    description: audit.description || '',
                    displayValue: audit.displayValue || '',
                    score: audit.score || 0,
                    details: audit.details || null
                };
                
                // Categorize based on content
                if (audit.details && (audit.details.items || audit.details.headings)) {
                    improvements.push(item);
                } else {
                    diagnostics.push(item);
                }
            }
        });

        // Sort opportunities by impact
        opportunities.sort((a, b) => b.impact - a.impact);

        contentElement.innerHTML = `
            <div class="space-y-6">
                <!-- Screenshot and Scores Row -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Screenshot Card -->
                    <div class="lg:col-span-1">
                        <div class="card bg-base-100 shadow-sm border border-base-300">
                            <div class="card-body p-4">
                                <h4 class="text-sm font-semibold mb-3 text-base-content">
                                    <i class="fas fa-mobile-alt mr-2"></i>
                                    ${device.charAt(0).toUpperCase() + device.slice(1)} View
                                </h4>
                                ${finalScreenshot ? `
                                    <img src="${finalScreenshot}" alt="${device} screenshot" 
                                         class="rounded-lg shadow-md w-full" 
                                         style="max-height: 400px; object-fit: contain; background: #f3f4f6;">
                                ` : `
                                    <div class="bg-base-200 rounded-lg p-8 text-center">
                                        <i class="fas fa-image text-4xl text-base-content/20 mb-2"></i>
                                        <p class="text-sm text-base-content/60">No screenshot available</p>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Scores Grid -->
                    <div class="lg:col-span-2">
                        <div class="grid grid-cols-2 gap-4">
                            ${window.renderScoreCard('Performance', performanceScore, 'fa-tachometer-alt')}
                            ${window.renderScoreCard('Accessibility', accessibilityScore, 'fa-universal-access')}
                            ${window.renderScoreCard('Best Practices', bestPracticesScore, 'fa-shield-alt')}
                            ${window.renderScoreCard('SEO', seoScore, 'fa-search')}
                        </div>
                    </div>
                </div>

                <!-- Web Vitals -->
                <div class="card bg-base-100 shadow-sm border border-base-300">
                    <div class="card-body">
                        <h3 class="text-lg font-semibold mb-4">Core Web Vitals</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            ${window.renderMetric('First Contentful Paint', metrics.fcp, window.getMetricStatus(audits['first-contentful-paint']))}
                            ${window.renderMetric('Largest Contentful Paint', metrics.lcp, window.getMetricStatus(audits['largest-contentful-paint']))}
                            ${window.renderMetric('Cumulative Layout Shift', metrics.cls, window.getMetricStatus(audits['cumulative-layout-shift']))}
                        </div>
                    </div>
                </div>

                <!-- Other Metrics -->
                <div class="card bg-base-100 shadow-sm border border-base-300">
                    <div class="card-body">
                        <h3 class="text-lg font-semibold mb-4">Performance Metrics</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            ${window.renderMetric('Speed Index', metrics.si, window.getMetricStatus(audits['speed-index']))}
                            ${window.renderMetric('Time to Interactive', metrics.tti, window.getMetricStatus(audits['interactive']))}
                            ${window.renderMetric('Total Blocking Time', metrics.tbt, window.getMetricStatus(audits['total-blocking-time']))}
                        </div>
                    </div>
                </div>

                <!-- Loading Timeline (Filmstrip) -->
                ${screenshotThumbnails.length > 0 ? `
                <div class="card bg-base-100 shadow-sm border border-base-300">
                    <div class="card-body">
                        <h3 class="text-lg font-semibold mb-4">
                            <i class="fas fa-film text-info mr-2"></i>
                            Loading Timeline
                        </h3>
                        <div class="overflow-x-auto pb-2">
                            <div class="flex gap-2" style="min-width: max-content;">
                                ${screenshotThumbnails.map(thumb => `
                                    <div class="flex-shrink-0 text-center">
                                        <img src="${thumb.data}" alt="Loading at ${thumb.timing}ms" 
                                             class="rounded shadow-sm mb-1" 
                                             style="height: 100px; width: auto;">
                                        <p class="text-xs text-base-content/60">${thumb.timing}ms</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
                ` : ''}

                <!-- Opportunities -->
                ${opportunities.length > 0 ? `
                <div class="card bg-base-100 shadow-sm border border-base-300">
                    <div class="card-body">
                        <h3 class="text-lg font-semibold mb-4">
                            <i class="fas fa-lightbulb text-warning mr-2"></i>
                            Opportunities
                        </h3>
                        <p class="text-sm text-base-content/60 mb-4">These suggestions can help your page load faster.</p>
                        <div class="space-y-3">
                            ${opportunities.map(opp => window.renderOpportunity(opp)).join('')}
                        </div>
                    </div>
                </div>
                ` : ''}

                <!-- Improvement Suggestions -->
                ${improvements.length > 0 ? `
                <div class="card bg-base-100 shadow-sm border border-base-300">
                    <div class="card-body">
                        <h3 class="text-lg font-semibold mb-2">
                            <i class="fas fa-clipboard-list text-info mr-2"></i>
                            Performance Improvement Checklist
                        </h3>
                        <p class="text-sm text-base-content/60 mb-1">These audits highlight areas where your site can be optimized.</p>
                        <p class="text-xs text-base-content/50 mb-4">Click on each item to see affected resources and detailed recommendations.</p>
                        <div class="space-y-3">
                            ${improvements.map(imp => window.renderImprovement(imp)).join('')}
                        </div>
                    </div>
                </div>
                ` : ''}

                <!-- Diagnostics -->
                ${diagnostics.length > 0 ? `
                <div class="card bg-base-100 shadow-sm border border-base-300">
                    <div class="card-body">
                        <h3 class="text-lg font-semibold mb-4">
                            <i class="fas fa-stethoscope text-info mr-2"></i>
                            Diagnostics
                        </h3>
                        <p class="text-sm text-base-content/60 mb-4">Additional items to check.</p>
                        <div class="space-y-2">
                            ${diagnostics.slice(0, 10).map(diag => window.renderDiagnostic(diag)).join('')}
                        </div>
                    </div>
                </div>
                ` : ''}
            </div>
        `;
    }

    window.renderScoreCard = function(title, score, icon) {
        const color = window.getScoreColor(score);
        return `
            <div class="metric-card">
                <div class="flex flex-col items-center w-full">
                    <div class="score-circle mb-2 relative">
                        <svg width="80" height="80">
                            <circle cx="40" cy="40" r="36" fill="none" stroke="#e5e7eb" stroke-width="4"/>
                            <circle cx="40" cy="40" r="36" fill="none" stroke="${color}" stroke-width="4"
                                    stroke-dasharray="${score * 2.26} 226"
                                    stroke-linecap="round"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-2xl font-bold" style="color: ${color}">${score}</span>
                        </div>
                    </div>
                    <div class="text-center">
                        <h4 class="text-sm font-medium text-base-content">${title}</h4>
                    </div>
                </div>
            </div>
        `;
    }

    window.renderMetric = function(title, value, status) {
        const statusColors = {
            'good': 'text-success',
            'needs-improvement': 'text-warning',
            'poor': 'text-error'
        };
        const statusIcons = {
            'good': 'fa-check-circle',
            'needs-improvement': 'fa-exclamation-circle',
            'poor': 'fa-times-circle'
        };
        
        return `
            <div class="flex items-center justify-between p-4 bg-base-200/50 rounded-lg">
                <div>
                    <p class="text-sm text-base-content/60">${title}</p>
                    <p class="text-xl font-semibold ${statusColors[status] || ''}">${value}</p>
                </div>
                <i class="fas ${statusIcons[status] || 'fa-question-circle'} text-2xl ${statusColors[status] || 'text-base-content/40'}"></i>
            </div>
        `;
    }

    window.renderOpportunity = function(opp) {
        const impactClass = opp.impact > 1000 ? 'high-impact' : opp.impact > 500 ? 'medium-impact' : 'low-impact';
        const hasDetails = opp.details && opp.details.items && opp.details.items.length > 0;
        
        return `
            <div class="opportunity-card ${impactClass}">
                <div class="collapse collapse-arrow">
                    <input type="checkbox" id="opp-${opp.id}" />
                    <div class="collapse-title pr-12" style="min-height: auto; padding-top: 0; padding-bottom: 0;">
                        <div class="flex justify-between items-center py-4">
                            <div class="flex-1 pr-4">
                                <h4 class="font-medium text-base-content mb-1">${opp.title}</h4>
                                <p class="text-sm text-base-content/60">${opp.description}</p>
                            </div>
                            ${opp.displayValue ? `
                            <div class="ml-4 text-right flex-shrink-0 flex items-center">
                                <span class="text-sm font-medium text-base-content whitespace-nowrap">${opp.displayValue}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    ${hasDetails ? `
                    <div class="collapse-content">
                        <div class="pt-2 px-4 pb-4">
                            <div class="bg-base-200/50 rounded-lg p-3">
                                ${window.renderAuditDetails(opp.details)}
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    }
    
    window.renderImprovement = function(imp) {
        const hasDetails = imp.details && (imp.details.items || imp.details.headings);
        
        // Choose icon based on score/severity
        let iconClass = 'fa-exclamation-circle text-warning';
        if (imp.score <= 0.2) {
            iconClass = 'fa-times-circle text-error';
        } else if (imp.score >= 0.8) {
            iconClass = 'fa-info-circle text-info';
        }
        
        // Format the description - if empty or same as title, provide helpful text
        let description = imp.description || '';
        if (!description || description === imp.title) {
            // Provide default helpful descriptions based on common audit IDs
            const defaultDescriptions = {
                'errors-in-console': 'Fix JavaScript errors in the browser console to ensure your site functions properly.',
                'total-byte-weight': 'Reduce the total size of network requests to improve load time.',
                'unsized-images': 'Set explicit width and height on image elements to prevent layout shift.',
                'long-tasks': 'Break up long-running JavaScript tasks to keep the page responsive.',
                'unused-javascript': 'Remove or defer unused JavaScript to reduce bytes consumed by network activity.',
                'unused-css-rules': 'Remove dead CSS rules to reduce bytes consumed by network activity.',
                'non-composited-animations': 'Use CSS transform and opacity for better animation performance.',
                'uses-text-compression': 'Enable text compression to reduce the byte size of text-based resources.',
                'uses-long-cache-ttl': 'Serve static assets with an efficient cache policy.',
                'dom-size': 'Reduce the number of DOM elements to improve page performance.'
            };
            description = defaultDescriptions[imp.id] || 'Review this audit item for potential performance improvements.';
        }
        
        return `
            <div class="border border-base-300 rounded-lg hover:shadow-md transition-shadow">
                <div class="collapse collapse-arrow">
                    <input type="checkbox" id="imp-${imp.id}" />
                    <div class="collapse-title pr-12" style="min-height: auto; padding-top: 0; padding-bottom: 0;">
                        <div class="py-4">
                            <div class="flex items-start gap-3">
                                <i class="fas ${iconClass} mt-1 flex-shrink-0"></i>
                                <div class="flex-1 pr-4">
                                    <h4 class="font-medium text-base-content mb-1">${imp.title.replace(/`/g, '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</h4>
                                    <p class="text-sm text-base-content/70">${description}</p>
                                    ${imp.displayValue ? `
                                    <div class="flex items-center gap-2 mt-2">
                                        <span class="badge badge-sm badge-ghost">${imp.displayValue}</span>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    ${hasDetails ? `
                    <div class="collapse-content">
                        <div class="pt-2 px-4 pb-4">
                            <div class="bg-base-200/30 rounded-lg p-3">
                                <p class="text-xs font-semibold text-base-content/80 mb-2">Affected Resources:</p>
                                ${window.renderAuditDetails(imp.details)}
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    }
    
    window.renderAuditDetails = function(details) {
        if (!details) return '';
        
        // Handle table-like data
        if (details.items && details.items.length > 0) {
            const items = details.items.slice(0, 5); // Show first 5 items
            const headers = details.headings || [];
            
            if (headers.length > 0) {
                return `
                    <div class="overflow-x-auto">
                        <table class="table table-xs">
                            <thead>
                                <tr>
                                    ${headers.map(h => `<th class="text-xs">${h.label || h.key}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map(item => `
                                    <tr>
                                        ${headers.map(h => {
                                            let value = item[h.key];
                                            
                                            // Handle complex object types
                                            if (typeof value === 'object' && value !== null) {
                                                // Handle node/element objects
                                                if (value.type === 'node' || h.valueType === 'node') {
                                                    const selector = value.selector || value.nodeLabel || value.snippet || '';
                                                    // Clean up the selector/snippet for display
                                                    const cleanText = selector
                                                        .replace(/<[^>]*>/g, '') // Remove HTML tags
                                                        .replace(/&lt;/g, '<')
                                                        .replace(/&gt;/g, '>')
                                                        .replace(/&amp;/g, '&')
                                                        .substring(0, 100); // Limit length
                                                    return `<td class="text-xs font-mono truncate max-w-xs" title="${selector.replace(/"/g, '&quot;')}">${cleanText}${cleanText.length >= 100 ? '...' : ''}</td>`;
                                                }
                                                // Handle URL objects
                                                else if (value.type === 'url' || h.valueType === 'url') {
                                                    const url = value.value || value.url || value;
                                                    return `<td class="text-xs truncate max-w-xs" title="${url}">${url}</td>`;
                                                }
                                                // Handle bytes
                                                else if (value.type === 'bytes' || h.valueType === 'bytes') {
                                                    const bytes = value.value || value;
                                                    return `<td class="text-xs">${(bytes / 1024).toFixed(1)} KB</td>`;
                                                }
                                                // Handle milliseconds
                                                else if (value.type === 'ms' || h.valueType === 'ms') {
                                                    const ms = value.value || value;
                                                    return `<td class="text-xs">${ms} ms</td>`;
                                                }
                                                // Handle source location objects
                                                else if (value.source || value.line || value.column) {
                                                    const source = value.source || value.url || '';
                                                    const line = value.line || '';
                                                    const column = value.column || '';
                                                    const location = line ? `:${line}${column ? ':' + column : ''}` : '';
                                                    return `<td class="text-xs font-mono truncate max-w-xs" title="${source}${location}">${source}${location}</td>`;
                                                }
                                                // Default object handling - try to extract meaningful text
                                                else {
                                                    const text = value.text || value.label || value.value || value.snippet || value.selector || JSON.stringify(value);
                                                    return `<td class="text-xs truncate max-w-xs" title="${text.replace(/"/g, '&quot;')}">${text}</td>`;
                                                }
                                            }
                                            // Handle primitive values
                                            else if (value === null || value === undefined) {
                                                return `<td class="text-xs text-base-content/40">N/A</td>`;
                                            }
                                            else {
                                                // Handle numbers with appropriate formatting
                                                if (h.valueType === 'ms' && typeof value === 'number') {
                                                    return `<td class="text-xs">${value.toFixed(0)} ms</td>`;
                                                }
                                                else if (h.valueType === 'bytes' && typeof value === 'number') {
                                                    return `<td class="text-xs">${(value / 1024).toFixed(1)} KB</td>`;
                                                }
                                                else if (typeof value === 'number') {
                                                    return `<td class="text-xs">${value.toFixed(2)}</td>`;
                                                }
                                                else {
                                                    return `<td class="text-xs">${value}</td>`;
                                                }
                                            }
                                        }).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ${details.items.length > 5 ? `
                        <p class="text-xs text-base-content/50 mt-2">And ${details.items.length - 5} more items...</p>
                        ` : ''}
                    </div>
                `;
            } else {
                // Simple list if no headers
                return `
                    <ul class="list-disc list-inside text-sm space-y-1">
                        ${items.map(item => {
                            let text = '';
                            if (typeof item === 'string') {
                                text = item;
                            } else if (typeof item === 'object' && item !== null) {
                                // Try to extract meaningful text from object
                                text = item.text || item.label || item.value || item.snippet || item.selector || JSON.stringify(item);
                            } else {
                                text = String(item);
                            }
                            return `<li class="text-base-content/80">${text}</li>`;
                        }).join('')}
                    </ul>
                `;
            }
        }
        
        return '<p class="text-xs text-base-content/60">No additional details available</p>';
    }

    window.renderDiagnostic = function(diag) {
        return `
            <div class="diagnostic-item">
                <span class="text-sm text-base-content">${diag.title}</span>
                ${diag.displayValue ? `<span class="text-sm text-base-content/60">${diag.displayValue}</span>` : ''}
            </div>
        `;
    }

    window.getScoreColor = function(score) {
        if (score >= 90) return '#10b981';
        if (score >= 50) return '#f59e0b';
        return '#ef4444';
    }

    window.getMetricStatus = function(audit) {
        if (!audit || audit.score === null) return 'unknown';
        if (audit.score >= 0.9) return 'good';
        if (audit.score >= 0.5) return 'needs-improvement';
        return 'poor';
    }
</script>