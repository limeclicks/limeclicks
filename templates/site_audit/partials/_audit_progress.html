<!-- Audit Progress Component -->
<div id="audit-progress-{{ audit.id }}" 
     hx-ext="sse" 
     sse-connect="/site-audit/{{ audit.id }}/status-stream/"
     class="audit-progress-container">
    
    <!-- Site Audit Progress -->
    <div class="mb-4">
        <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-base-content">Site Audit</span>
            <span id="site-progress-text-{{ audit.id }}" class="text-xs text-base-content/60">
                {% if audit.has_running_audit %}Starting...{% else %}Completed{% endif %}
            </span>
        </div>
        <div class="w-full bg-base-300 rounded-full h-2">
            <div id="site-progress-bar-{{ audit.id }}" 
                 class="bg-primary h-2 rounded-full transition-all duration-300"
                 style="width: {% if audit.has_running_audit %}5%{% else %}100%{% endif %}">
            </div>
        </div>
        <div id="site-details-{{ audit.id }}" class="text-xs text-base-content/50 mt-1">
            {% if audit.has_running_audit %}
                <span>Initializing crawler...</span>
            {% else %}
                <span>{{ audit.total_pages_crawled }} pages crawled</span>
            {% endif %}
        </div>
    </div>
    
    <!-- Performance Audit Progress -->
    <div class="mb-4">
        <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-base-content">Performance Audit</span>
            <span id="perf-progress-text-{{ audit.id }}" class="text-xs text-base-content/60">
                {% if audit.performance_score_mobile %}Completed{% else %}Starting...{% endif %}
            </span>
        </div>
        <div class="w-full bg-base-300 rounded-full h-2">
            <div id="perf-progress-bar-{{ audit.id }}" 
                 class="bg-secondary h-2 rounded-full transition-all duration-300"
                 style="width: {% if audit.performance_score_mobile %}100%{% else %}5%{% endif %}">
            </div>
        </div>
        <div id="perf-details-{{ audit.id }}" class="text-xs text-base-content/50 mt-1">
            {% if audit.performance_score_mobile %}
                <span>Mobile: {{ audit.performance_score_mobile }}, Desktop: {{ audit.performance_score_desktop }}</span>
            {% else %}
                <span>Running Lighthouse analysis...</span>
            {% endif %}
        </div>
    </div>
</div>

<script>
// SSE Event handlers for audit {{ audit.id }}
document.addEventListener('DOMContentLoaded', function() {
    const progressContainer = document.getElementById('audit-progress-{{ audit.id }}');
    
    if (progressContainer) {
        // Listen for SSE messages
        progressContainer.addEventListener('sse:message', function(event) {
            const data = JSON.parse(event.detail.data);
            updateAuditProgress({{ audit.id }}, data);
        });
        
        progressContainer.addEventListener('sse:error', function(event) {
            console.error('SSE error for audit {{ audit.id }}:', event);
            showErrorState({{ audit.id }});
        });
        
        progressContainer.addEventListener('sse:close', function(event) {
            console.log('SSE connection closed for audit {{ audit.id }}');
            finalizeAuditDisplay({{ audit.id }});
        });
    }
});

function updateAuditProgress(auditId, data) {
    if (data.error) {
        showErrorState(auditId);
        return;
    }
    
    // Update Site Audit Progress
    if (data.site_audit) {
        const siteProgressBar = document.getElementById(`site-progress-bar-${auditId}`);
        const siteProgressText = document.getElementById(`site-progress-text-${auditId}`);
        const siteDetails = document.getElementById(`site-details-${auditId}`);
        
        if (siteProgressBar) {
            siteProgressBar.style.width = `${data.site_audit.progress}%`;
        }
        
        if (siteProgressText) {
            let statusText = '';
            switch(data.site_audit.status) {
                case 'pending':
                    statusText = 'Queued';
                    break;
                case 'running':
                    statusText = `Running (${data.site_audit.progress}%)`;
                    break;
                case 'completed':
                    statusText = 'Completed';
                    break;
                case 'failed':
                    statusText = 'Failed';
                    siteProgressBar.classList.remove('bg-primary');
                    siteProgressBar.classList.add('bg-error');
                    break;
                default:
                    statusText = 'Not Started';
            }
            siteProgressText.textContent = statusText;
        }
        
        if (siteDetails) {
            if (data.site_audit.status === 'running') {
                siteDetails.innerHTML = `<span>Crawling... ${data.site_audit.pages_crawled} pages found</span>`;
                if (data.site_audit.retry_count > 0) {
                    siteDetails.innerHTML += ` <span class="text-warning">(Retry ${data.site_audit.retry_count})</span>`;
                }
            } else if (data.site_audit.status === 'completed') {
                siteDetails.innerHTML = `<span>${data.site_audit.pages_crawled} pages crawled</span>`;
            } else if (data.site_audit.status === 'failed') {
                siteDetails.innerHTML = `<span class="text-error">Failed: ${data.site_audit.error_message || 'Unknown error'}</span>`;
            }
        }
    }
    
    // Update Performance Audit Progress
    if (data.performance_audit) {
        const perfProgressBar = document.getElementById(`perf-progress-bar-${auditId}`);
        const perfProgressText = document.getElementById(`perf-progress-text-${auditId}`);
        const perfDetails = document.getElementById(`perf-details-${auditId}`);
        
        if (perfProgressBar) {
            perfProgressBar.style.width = `${data.performance_audit.progress}%`;
        }
        
        if (perfProgressText) {
            let statusText = '';
            switch(data.performance_audit.status) {
                case 'pending':
                    statusText = 'Queued';
                    break;
                case 'running':
                    statusText = `Running (${data.performance_audit.progress}%)`;
                    break;
                case 'completed':
                    statusText = 'Completed';
                    break;
                case 'failed':
                    statusText = 'Failed';
                    perfProgressBar.classList.remove('bg-secondary');
                    perfProgressBar.classList.add('bg-error');
                    break;
                default:
                    statusText = 'Not Started';
            }
            perfProgressText.textContent = statusText;
        }
        
        if (perfDetails) {
            if (data.performance_audit.status === 'running') {
                perfDetails.innerHTML = '<span>Running Lighthouse analysis...</span>';
            } else if (data.performance_audit.status === 'completed') {
                const mobile = data.performance_audit.mobile_score || 'N/A';
                const desktop = data.performance_audit.desktop_score || 'N/A';
                perfDetails.innerHTML = `<span>Mobile: ${mobile}, Desktop: ${desktop}</span>`;
            } else if (data.performance_audit.status === 'failed') {
                perfDetails.innerHTML = '<span class="text-error">Analysis failed</span>';
            }
        }
    }
    
    // If both audits are completed, refresh the page after a short delay
    if (data.final || (
        data.site_audit && data.site_audit.status === 'completed' &&
        data.performance_audit && data.performance_audit.status === 'completed'
    )) {
        setTimeout(() => {
            location.reload();
        }, 2000); // 2 second delay to show final status
    }
}

function showErrorState(auditId) {
    const siteProgressBar = document.getElementById(`site-progress-bar-${auditId}`);
    const perfProgressBar = document.getElementById(`perf-progress-bar-${auditId}`);
    const siteProgressText = document.getElementById(`site-progress-text-${auditId}`);
    const perfProgressText = document.getElementById(`perf-progress-text-${auditId}`);
    
    if (siteProgressBar) {
        siteProgressBar.classList.remove('bg-primary');
        siteProgressBar.classList.add('bg-error');
        siteProgressBar.style.width = '100%';
    }
    if (perfProgressBar) {
        perfProgressBar.classList.remove('bg-secondary');
        perfProgressBar.classList.add('bg-error');
        perfProgressBar.style.width = '100%';
    }
    if (siteProgressText) siteProgressText.textContent = 'Error';
    if (perfProgressText) perfProgressText.textContent = 'Error';
}

function finalizeAuditDisplay(auditId) {
    console.log(`Finalizing audit display for ${auditId}`);
    // Optionally show a completion message or refresh
}
</script>