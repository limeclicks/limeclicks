{% extends "dashboard_base.html" %}
{% load static %}

{% block title %}Site Audits - LimeClicks{% endblock %}
{% block page_title %}Site Audits{% endblock %}

{% block extra_head %}
<style>
    .audit-card {
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .audit-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .loading-spinner {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    .pulse-dot {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
        }
    }
    
    .health-bar {
        transition: width 1s ease-out;
    }
    
    .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
    }
    
    @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header Section -->
    <div class="mb-8">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-3xl font-bold text-base-content">Site Audits</h1>
                <p class="text-base-content/60 mt-1">Monitor and analyze your website's SEO health</p>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="openCreateProjectModal()" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i>
                    Create Project
                </button>
                <button onclick="location.reload()" class="btn btn-circle btn-ghost">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
        
        <!-- Search and Filter Card -->
        <div class="card bg-base-100 shadow-sm border border-base-300">
            <div class="card-body p-4">
                <!-- Search Bar -->
                <div class="relative mb-4">
                    <input 
                        type="text" 
                        id="search-input"
                        name="search"
                        placeholder="Search by domain or project name..." 
                        class="input input-bordered w-full pl-12 pr-4 h-12"
                        value="{{ search_query }}"
                        hx-get="{% url 'site_audit:list' %}"
                        hx-trigger="keyup changed delay:500ms"
                        hx-target="#audit-list"
                        hx-swap="innerHTML"
                        hx-vals='{"filter": "{{ filter_status|default:"all" }}"}'
                        hx-indicator="#search-spinner"
                    >
                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-base-content/40"></i>
                    <span id="search-spinner" class="htmx-indicator absolute right-4 top-1/2 -translate-y-1/2">
                        <i class="fas fa-spinner loading-spinner text-primary"></i>
                    </span>
                </div>
                
                <!-- Filter Buttons -->
                <div class="flex items-center gap-2">
                    <span class="text-sm text-base-content/60 mr-2">Filter:</span>
                    
                    <!-- All Filter (default) -->
                    <button 
                        type="button"
                        name="filter"
                        value="all"
                        class="btn btn-sm {% if filter_status == 'all' or not filter_status %}btn-primary{% else %}btn-outline{% endif %}"
                        hx-get="{% url 'site_audit:list' %}"
                        hx-trigger="click"
                        hx-target="#audit-list"
                        hx-swap="innerHTML"
                        hx-include="#search-input"
                        hx-vals='{"filter": "all"}'
                        onclick="updateFilterButtons(this)"
                    >
                        All
                        <span class="badge badge-sm ml-1">{{ total_projects }}</span>
                    </button>
                    
                    <!-- Healthy Filter -->
                    <button 
                        type="button"
                        name="filter"
                        value="healthy"
                        class="btn btn-sm {% if filter_status == 'healthy' %}btn-success{% else %}btn-outline btn-success{% endif %}"
                        hx-get="{% url 'site_audit:list' %}"
                        hx-trigger="click"
                        hx-target="#audit-list"
                        hx-swap="innerHTML"
                        hx-include="#search-input"
                        hx-vals='{"filter": "healthy"}'
                        onclick="updateFilterButtons(this)"
                    >
                        <i class="fas fa-check-circle mr-1"></i>
                        Healthy
                        <span class="badge badge-sm ml-1">{{ healthy_count }}</span>
                    </button>
                    
                    <!-- Need Attention Filter -->
                    <button 
                        type="button"
                        name="filter"
                        value="attention"
                        class="btn btn-sm {% if filter_status == 'attention' %}btn-warning{% else %}btn-outline btn-warning{% endif %}"
                        hx-get="{% url 'site_audit:list' %}"
                        hx-trigger="click"
                        hx-target="#audit-list"
                        hx-swap="innerHTML"
                        hx-include="#search-input"
                        hx-vals='{"filter": "attention"}'
                        onclick="updateFilterButtons(this)"
                    >
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        Need Attention
                        <span class="badge badge-sm ml-1">{{ attention_count }}</span>
                    </button>
                    
                    <!-- Critical Filter -->
                    <button 
                        type="button"
                        name="filter"
                        value="critical"
                        class="btn btn-sm {% if filter_status == 'critical' %}btn-error{% else %}btn-outline btn-error{% endif %}"
                        hx-get="{% url 'site_audit:list' %}"
                        hx-trigger="click"
                        hx-target="#audit-list"
                        hx-swap="innerHTML"
                        hx-include="#search-input"
                        hx-vals='{"filter": "critical"}'
                        onclick="updateFilterButtons(this)"
                    >
                        <i class="fas fa-times-circle mr-1"></i>
                        Critical
                        <span class="badge badge-sm ml-1">{{ critical_count }}</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <!-- Total Projects Card -->
        <div class="card bg-base-100 shadow-sm border border-base-300">
            <div class="card-body p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-base-content/60 text-sm">Total Projects</p>
                        <p class="text-2xl font-bold text-base-content" data-stat="total">{{ total_projects }}</p>
                    </div>
                    <div class="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                        <i class="fas fa-folder text-primary text-lg"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Healthy Sites Card -->
        <div class="card bg-base-100 shadow-sm border border-base-300">
            <div class="card-body p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-base-content/60 text-sm">Healthy Sites</p>
                        <p class="text-2xl font-bold text-success">{{ healthy_count }}</p>
                    </div>
                    <div class="w-12 h-12 bg-success/10 rounded-lg flex items-center justify-center">
                        <i class="fas fa-check-circle text-success text-lg"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Need Attention Card -->
        <div class="card bg-base-100 shadow-sm border border-base-300">
            <div class="card-body p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-base-content/60 text-sm">Need Attention</p>
                        <p class="text-2xl font-bold text-warning">{{ attention_count }}</p>
                    </div>
                    <div class="w-12 h-12 bg-warning/10 rounded-lg flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-warning text-lg"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Critical Sites Card -->
        <div class="card bg-base-100 shadow-sm border border-base-300">
            <div class="card-body p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-base-content/60 text-sm">Critical Sites</p>
                        <p class="text-2xl font-bold text-error">{{ critical_count }}</p>
                    </div>
                    <div class="w-12 h-12 bg-error/10 rounded-lg flex items-center justify-center">
                        <i class="fas fa-times-circle text-error text-lg"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Audit List -->
    <div id="audit-list">
        <div class="grid grid-cols-1 gap-4" id="audit-cards-container">
            {% if projects_with_audits %}
                <!-- Existing Projects -->
                {% for item in projects_with_audits %}
                    {% include "site_audit/partials/audit_card.html" %}
                {% endfor %}
            {% else %}
                <!-- Empty State -->
                {% include "site_audit/partials/empty_state.html" %}
            {% endif %}
        </div>
        
        {% if has_next %}
        <!-- Load More Button -->
        <div class="text-center mt-8" id="load-more-container">
            <button 
                class="btn btn-primary btn-outline"
                hx-get="{% url 'site_audit:list' %}?page={{ next_page }}"
                hx-trigger="click"
                hx-target="#audit-cards-container"
                hx-select=".audit-card"
                hx-swap="beforeend"
                hx-indicator="#load-more-spinner"
            >
                <span id="load-more-text">Load More</span>
                <span id="load-more-spinner" class="htmx-indicator">
                    <i class="fas fa-spinner loading-spinner ml-2"></i>
                </span>
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal Container for HTMX -->
<!-- Include Unified Create Project Modal -->
{% include 'partials/create_project_modal.html' %}

<!-- Modal container for HTMX (if still needed for other modals) -->
<div id="modal-container"></div>

<!-- Minimal JavaScript for real-time updates using native EventSource -->
<script>
    // Function to update filter button styles
    function updateFilterButtons(clickedBtn) {
        // Remove filled state from all filter buttons
        document.querySelectorAll('[name="filter"]').forEach(btn => {
            btn.classList.remove('btn-primary', 'btn-success', 'btn-warning', 'btn-error');
            
            // Add outline style based on button type
            if (btn.textContent.includes('Healthy')) {
                btn.classList.add('btn-outline', 'btn-success');
            } else if (btn.textContent.includes('Need Attention')) {
                btn.classList.add('btn-outline', 'btn-warning');
            } else if (btn.textContent.includes('Critical')) {
                btn.classList.add('btn-outline', 'btn-error');
            } else if (btn.textContent.includes('All')) {
                btn.classList.add('btn-outline');
            }
        });
        
        // Add filled state to clicked button
        clickedBtn.classList.remove('btn-outline');
        if (clickedBtn.value === 'healthy') {
            clickedBtn.classList.add('btn-success');
        } else if (clickedBtn.value === 'attention') {
            clickedBtn.classList.add('btn-warning');
        } else if (clickedBtn.value === 'critical') {
            clickedBtn.classList.add('btn-error');
        } else {
            clickedBtn.classList.add('btn-primary');
        }
    }
    
    // Use native EventSource for better compatibility
    let eventSource;
    
    function initSSE() {
        console.log('Initializing SSE connection...');
        
        if (eventSource) {
            eventSource.close();
        }
        
        eventSource = new EventSource("{% url 'site_audit:status_stream' %}");
        
        eventSource.onopen = function() {
            console.log('SSE connection opened');
        };
        
        eventSource.onerror = function(error) {
            console.error('SSE connection error:', error);
            // Reconnect after 5 seconds
            setTimeout(initSSE, 5000);
        };
        
        // Listen for audit_update events
        eventSource.addEventListener('audit_update', function(event) {
            try {
                const data = JSON.parse(event.data);
                console.log('Received audit update:', data);
                
                // Log for debugging
                if (data.update_type === 'status_update') {
                    console.log(`Status update: Project ${data.project_id} - ${data.previous_status || 'new'} â†’ ${data.status}`);
                } else {
                    console.log(`Score update: Project ${data.project_id} - Health: ${data.health_score}`);
                }
                
                // Update the specific project card for any change (status or scores)
                if (data.project_id) {
                    // Use HTMX to fetch updated card HTML
                    htmx.ajax('GET', `/site-audit/card/${data.project_id}/`, {
                        target: `#project-card-${data.project_id}`,
                        swap: 'outerHTML'
                    }).then(() => {
                        console.log(`Card updated for project ${data.project_id}`);
                    });
                    
                    // Show notification only for new completions (not already completed audits)
                    // Use the is_new_completion flag to determine if this is a real new completion
                    if (data.is_new_completion === true) {
                        showNotification('completed', data.project_id);
                    } else if (data.update_type === 'status_update' && data.status === 'failed' && data.previous_status !== 'failed') {
                        showNotification('failed', data.project_id);
                    }
                }
            } catch (e) {
                console.error('Error processing SSE event:', e);
            }
        });
        
        // Also listen for regular messages (heartbeat)
        eventSource.onmessage = function(event) {
            // Ignore heartbeat messages
            if (event.data && !event.data.includes('heartbeat')) {
                console.log('Received message:', event.data);
            }
        };
    }
    
    function showNotification(status, projectId) {
        const message = status === 'completed' 
            ? 'Site audit completed successfully!' 
            : 'Site audit failed. Please try again.';
        
        const alertClass = status === 'completed' ? 'alert-success' : 'alert-error';
        
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert ${alertClass} fixed top-20 right-4 z-50 shadow-lg max-w-sm`;
        notification.innerHTML = `
            <i class="fas fa-${status === 'completed' ? 'check' : 'times'}-circle"></i>
            <span>${message}</span>
        `;
        
        document.body.appendChild(notification);
        
        // Remove after 5 seconds
        setTimeout(() => {
            notification.remove();
        }, 5000);
    }
    
    // Handle search input and other initialization
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize SSE connection
        initSSE();
        
        // Handle search input
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.addEventListener('input', function(e) {
                // Update URL parameter without reload
                const url = new URL(window.location);
                if (e.target.value) {
                    url.searchParams.set('search', e.target.value);
                } else {
                    url.searchParams.delete('search');
                }
                window.history.replaceState({}, '', url);
            });
        }
    });
    
    // Clean up SSE on page unload
    window.addEventListener('beforeunload', function() {
        if (eventSource) {
            eventSource.close();
            console.log('SSE connection closed');
        }
    });
    
    // Listen for HTMX events
    document.body.addEventListener('projectAdded', function(evt) {
        // Close modal (handled by HTMX)
        
        // Show success notification
        const notification = document.createElement('div');
        notification.className = 'alert alert-success fixed top-20 right-4 z-50 shadow-lg max-w-sm';
        notification.innerHTML = `
            <i class="fas fa-check-circle"></i>
            <span>Project added successfully!</span>
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
        
        // Update statistics (you could make an HTMX call here to refresh stats)
        // For now, we'll just increment the total
        const totalElement = document.querySelector('[data-stat="total"]');
        if (totalElement) {
            const current = parseInt(totalElement.textContent);
            totalElement.textContent = current + 1;
        }
    });
</script>
{% endblock %}