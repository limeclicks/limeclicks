<!-- Unified Project Creation Modal Component -->
<!-- Usage: Include this template using the include tag -->

<div id="create-project-modal" class="modal">
    <div class="modal-box max-w-2xl">
        <div class="flex justify-between items-center mb-6">
            <h3 class="font-bold text-lg">Create New Project</h3>
            <button onclick="closeCreateProjectModal()" class="btn btn-sm btn-circle btn-ghost">âœ•</button>
        </div>
        
        <form id="unified-project-create-form">
            {% csrf_token %}
            
            <!-- Domain Input Section -->
            <div class="form-control w-full mb-4">
                <label class="label">
                    <span class="label-text font-medium">Domain</span>
                    <span class="label-text-alt text-error">*Required</span>
                </label>
                <input 
                    type="text" 
                    id="domain-input"
                    name="domain"
                    placeholder="example.com or blog.example.com" 
                    class="input input-bordered w-full" 
                    required 
                    autocomplete="off"
                />
                <div id="domain-error" class="text-error text-sm mt-1 hidden"></div>
                <label class="label">
                    <span class="label-text-alt text-base-content/60">Enter domain or subdomain. Protocol (http://), www, and paths will be removed automatically.</span>
                </label>
            </div>
            
            <!-- Title Input -->
            <div class="form-control w-full mb-4">
                <label class="label">
                    <span class="label-text font-medium">Project Name</span>
                    <span class="label-text-alt text-base-content/60">(optional)</span>
                </label>
                <input 
                    type="text" 
                    id="title-input"
                    name="title"
                    placeholder="My Website (auto-generated if left blank)" 
                    class="input input-bordered w-full" 
                />
            </div>
            
            <!-- Sharing Section -->
            <div class="divider">Team Sharing (Optional)</div>
            
            <div class="form-control w-full mb-4">
                <label class="label">
                    <span class="label-text font-medium">Invite Team Members</span>
                    <span class="label-text-alt text-base-content/60">Press Enter or comma to add</span>
                </label>
                
                <!-- Email Tags Container -->
                <div class="min-h-[48px] p-2 border border-base-300 rounded-lg bg-base-100 focus-within:border-primary transition-colors">
                    <div class="flex flex-wrap gap-2 items-center">
                        <div id="email-tags-container" class="flex flex-wrap gap-2">
                            <!-- Email tags will be added here dynamically -->
                        </div>
                        <input 
                            type="email"
                            id="email-tag-input"
                            placeholder="Enter email address" 
                            class="flex-1 min-w-[200px] outline-none bg-transparent px-2 py-1"
                            autocomplete="off"
                        />
                    </div>
                </div>
                
                <!-- Hidden input to store all emails for form submission -->
                <input type="hidden" id="share-emails-input" name="share_emails" value="" />
                
                <!-- Email validation error -->
                <div id="email-error" class="text-error text-sm mt-1 hidden"></div>
                
                <label class="label">
                    <span class="label-text-alt text-base-content/60">Team members can manage keywords and view site audits. Site audit will run automatically after project creation.</span>
                </label>
            </div>
            
            <!-- Success/Error Messages -->
            <div id="create-project-messages" class="mb-4"></div>
            
            <div class="modal-action">
                <button type="submit" class="btn btn-primary" id="create-btn">
                    <span id="create-btn-text">Create Project</span>
                    <span id="create-btn-spinner" class="loading loading-spinner loading-sm ml-2 hidden"></span>
                </button>
                <button type="button" onclick="closeCreateProjectModal()" class="btn btn-ghost">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
// Email tag system - declare globally for access in reset
let emailTags = new Set();

// Unified Project Creation Modal Logic
(function() {
    
    function validateEmail(email) {
        // More comprehensive regex that supports + in emails
        const emailRegex = /^[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}$/;
        return emailRegex.test(email);
    }
    
    function addEmailTag(email) {
        email = email.trim().toLowerCase();
        
        if (!email) return false;
        
        // Validate email
        if (!validateEmail(email)) {
            showEmailError(`Invalid email: ${email}`);
            return false;
        }
        
        // Check if already added
        if (emailTags.has(email)) {
            showEmailError(`Email already added: ${email}`);
            return false;
        }
        
        // Add to set
        emailTags.add(email);
        
        // Create tag element
        const tag = document.createElement('div');
        tag.className = 'badge badge-primary gap-2 px-3 py-2';
        tag.innerHTML = `
            <span>${email}</span>
            <button type="button" class="text-xs hover:text-error" onclick="removeEmailTag('${email}')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-3 h-3">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        `;
        
        document.getElementById('email-tags-container').appendChild(tag);
        
        // Update hidden input
        updateHiddenEmailInput();
        
        // Clear error
        hideEmailError();
        
        return true;
    }
    
    function removeEmailTag(email) {
        emailTags.delete(email);
        
        // Remove from DOM
        const container = document.getElementById('email-tags-container');
        const tags = container.querySelectorAll('.badge');
        tags.forEach(tag => {
            if (tag.querySelector('span').textContent === email) {
                tag.remove();
            }
        });
        
        // Update hidden input
        updateHiddenEmailInput();
    }
    
    function updateHiddenEmailInput() {
        document.getElementById('share-emails-input').value = Array.from(emailTags).join(',');
    }
    
    function showEmailError(message) {
        const errorDiv = document.getElementById('email-error');
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
        
        // Auto hide after 3 seconds
        setTimeout(() => {
            hideEmailError();
        }, 3000);
    }
    
    function hideEmailError() {
        const errorDiv = document.getElementById('email-error');
        errorDiv.classList.add('hidden');
    }
    
    // Email input handling
    const emailInput = document.getElementById('email-tag-input');
    if (emailInput) {
        emailInput.addEventListener('keydown', function(e) {
            const email = this.value.trim();
            
            // Add on Enter or comma
            if (e.key === 'Enter' || e.key === ',') {
                e.preventDefault();
                if (addEmailTag(email)) {
                    this.value = '';
                }
            }
            
            // Remove last tag on backspace if input is empty
            if (e.key === 'Backspace' && !email && emailTags.size > 0) {
                const lastEmail = Array.from(emailTags).pop();
                removeEmailTag(lastEmail);
            }
        });
        
        // Add on blur (when clicking away)
        emailInput.addEventListener('blur', function() {
            const email = this.value.trim();
            if (email) {
                if (addEmailTag(email)) {
                    this.value = '';
                }
            }
        });
        
        // Handle paste event for multiple emails
        emailInput.addEventListener('paste', function(e) {
            e.preventDefault();
            const pastedText = (e.clipboardData || window.clipboardData).getData('text');
            
            // Split by comma, semicolon, or newline
            const emails = pastedText.split(/[,;\n]+/);
            
            emails.forEach(email => {
                addEmailTag(email.trim());
            });
            
            this.value = '';
        });
    }
    
    // Make removeEmailTag globally accessible
    window.removeEmailTag = removeEmailTag;
    
    // Get CSRF token
    function getCookie(name) {
        const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
        return m ? m.pop() : '';
    }

    // Domain validation functions
    function cleanDomain(domain) {
        let cleaned = domain.toLowerCase().trim();
        // Remove protocol (http://, https://, ftp://, etc.)
        cleaned = cleaned.replace(/^[a-zA-Z]+:\/\//, '');
        // Remove www. prefix
        cleaned = cleaned.replace(/^www\./, '');
        // Remove path, query params, hash
        cleaned = cleaned.split('/')[0];
        cleaned = cleaned.split('?')[0];
        cleaned = cleaned.split('#')[0];
        // Remove port number if present (but not for IPv6)
        if (cleaned.indexOf('[') === -1) {
            cleaned = cleaned.split(':')[0];
        }
        // Remove trailing dots
        cleaned = cleaned.replace(/\.+$/, '');
        return cleaned;
    }

    function validateDomain(domain) {
        if (!domain) {
            return { valid: false, message: 'Domain is required.' };
        }
        
        // Must contain at least one dot
        if (!domain.includes('.')) {
            return { valid: false, message: 'Please enter a valid domain (must contain at least one dot).' };
        }
        
        // Check for invalid characters
        if (!/^[a-zA-Z0-9.-]+$/.test(domain)) {
            return { valid: false, message: 'Domain contains invalid characters.' };
        }
        
        // Check domain format
        const domainPattern = /^(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\.)*[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?$/;
        if (!domainPattern.test(domain)) {
            return { valid: false, message: 'Please enter a valid domain.' };
        }
        
        return { valid: true };
    }

    // Domain validation on input
    const domainInput = document.getElementById('domain-input');
    
    domainInput?.addEventListener('input', function() {
        const originalValue = this.value;
        const cleaned = cleanDomain(originalValue);
        
        // Always show the cleaned version in real-time
        if (originalValue !== cleaned) {
            this.value = cleaned;
        }
        
        // Validate domain
        const validation = validateDomain(this.value);
        const errorDiv = document.getElementById('domain-error');
        
        if (!validation.valid && this.value) {
            errorDiv.textContent = validation.message;
            errorDiv.classList.remove('hidden');
        } else {
            errorDiv.classList.add('hidden');
        }
    });
    
    // Clean domain on paste
    domainInput?.addEventListener('paste', function(e) {
        e.preventDefault();
        const pastedText = (e.clipboardData || window.clipboardData).getData('text');
        const cleaned = cleanDomain(pastedText);
        this.value = cleaned;
        
        // Trigger input event for validation
        const event = new Event('input', { bubbles: true });
        this.dispatchEvent(event);
    });
    
    // Clean domain on blur (when user clicks away)
    domainInput?.addEventListener('blur', function() {
        if (this.value) {
            this.value = cleanDomain(this.value);
            
            // Validate domain
            const validation = validateDomain(this.value);
            const errorDiv = document.getElementById('domain-error');
            
            if (!validation.valid && this.value) {
                errorDiv.textContent = validation.message;
                errorDiv.classList.remove('hidden');
            } else {
                errorDiv.classList.add('hidden');
            }
        }
    });

    // Form submission
    const form = document.getElementById('unified-project-create-form');
    form?.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('create-btn');
        const btnText = document.getElementById('create-btn-text');
        const btnSpinner = document.getElementById('create-btn-spinner');
        const messagesDiv = document.getElementById('create-project-messages');
        
        // Clean and validate domain
        let domain = cleanDomain(domainInput.value);
        const validation = validateDomain(domain);
        
        if (!validation.valid) {
            messagesDiv.innerHTML = `<div class="alert alert-error">${validation.message}</div>`;
            return;
        }
        
        // Show loading state
        submitBtn.disabled = true;
        btnText.textContent = 'Creating...';
        btnSpinner.classList.remove('hidden');
        messagesDiv.innerHTML = '';
        
        // Prepare data - share_emails is already updated in hidden input
        const formData = {
            domain: domain,
            title: document.getElementById('title-input').value,
            share_emails: document.getElementById('share-emails-input').value
        };
        
        try {
            // Create main project
            const response = await fetch('/projects/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(formData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                messagesDiv.innerHTML = `<div class="alert alert-success">Project created successfully! Site audit will run automatically.</div>`;
                
                // Redirect or refresh after a short delay
                setTimeout(() => {
                    if (window.location.pathname.includes('site-audit')) {
                        // If on site audit page, reload to show new project
                        window.location.reload();
                    } else {
                        // Otherwise go to projects page
                        window.location.href = '/projects/';
                    }
                }, 1500);
                
            } else {
                messagesDiv.innerHTML = `<div class="alert alert-error">${data.message || 'Error creating project'}</div>`;
                submitBtn.disabled = false;
                btnText.textContent = 'Create Project';
                btnSpinner.classList.add('hidden');
            }
        } catch (error) {
            messagesDiv.innerHTML = `<div class="alert alert-error">Network error: ${error.message}</div>`;
            submitBtn.disabled = false;
            btnText.textContent = 'Create Project';
            btnSpinner.classList.add('hidden');
        }
    });
})();

// Global modal functions
window.openCreateProjectModal = function() {
    const modal = document.getElementById('create-project-modal');
    modal.classList.add('modal-open');
    document.getElementById('unified-project-create-form').reset();
    document.getElementById('domain-error').classList.add('hidden');
    document.getElementById('create-project-messages').innerHTML = '';
    
    // Clear email tags
    emailTags.clear();
    document.getElementById('email-tags-container').innerHTML = '';
    document.getElementById('share-emails-input').value = '';
    document.getElementById('email-error').classList.add('hidden');
    
    // Focus on domain input
    setTimeout(() => {
        document.getElementById('domain-input')?.focus();
    }, 100);
}

window.closeCreateProjectModal = function() {
    const modal = document.getElementById('create-project-modal');
    modal.classList.remove('modal-open');
}

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = document.getElementById('create-project-modal');
        if (modal?.classList.contains('modal-open')) {
            closeCreateProjectModal();
        }
    }
});
</script>