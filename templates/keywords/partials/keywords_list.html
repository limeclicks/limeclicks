<!-- This partial should only return the table rows, not the full structure -->
<!-- Hidden element to pass sort state to JavaScript -->
<tr style="display: none;" data-sort-info="true" data-sort-by="{{ sort_by }}" data-sort-order="{{ sort_order }}"></tr>
{% for keyword in keywords %}
<tr class="keyword-row" data-keyword-id="{{ keyword.id }}">
    <td class="w-12">
        <input type="checkbox" 
               class="checkbox checkbox-sm keyword-checkbox"
               value="{{ keyword.id }}"
               onchange="updateBulkActions()">
    </td>
    <td>
        <div class="flex items-center gap-2">
            <a href="{% url 'keywords:keyword_detail' keyword.id %}" class="font-medium text-base-content hover:text-primary hover:underline">
                {{ keyword.keyword }}
            </a>
            {% if keyword.processing %}
            <span class="loading loading-spinner loading-xs text-primary" title="Checking rank..."></span>
            {% endif %}
        </div>
        {% if keyword.rank_url %}
        <div class="mt-1">
            <a href="{{ keyword.rank_url }}" target="_blank" class="text-xs text-base-content/60 hover:text-primary hover:underline block truncate max-w-xs" title="{{ keyword.rank_url }}">
                <i class="fas fa-link text-[10px] mr-1"></i>{{ keyword.rank_url|truncatechars:50 }}
            </a>
        </div>
        {% endif %}
        {% if keyword.keyword_tags.all %}
        <div class="flex flex-wrap gap-1 mt-1">
            {% for keyword_tag in keyword.keyword_tags.all %}
            <span class="badge badge-sm" style="background-color: {{ keyword_tag.tag.color }}; color: white;">
                {{ keyword_tag.tag.name }}
            </span>
            {% endfor %}
        </div>
        {% endif %}
    </td>
    <td class="text-center rank-cell">
        {% if keyword.processing %}
            <span class="badge badge-ghost gap-1">
                <span class="loading loading-spinner loading-xs"></span>
                Checking
            </span>
        {% elif keyword.rank > 0 and keyword.rank <= 100 %}
            <span class="badge rank-badge 
                {% if keyword.rank == 1 %}rank-1{% elif keyword.rank == 2 %}rank-2{% elif keyword.rank == 3 %}rank-3{% elif keyword.rank <= 10 %}rank-top10{% elif keyword.rank <= 30 %}rank-top30{% elif keyword.rank <= 50 %}rank-top50{% else %}rank-top100{% endif %}">
                #{{ keyword.rank }}
            </span>
        {% else %}
            <span class="badge rank-badge rank-none">NR</span>
        {% endif %}
    </td>
    <td class="text-center change-cell">
        {% if keyword.processing %}
            <span class="text-base-content/40">-</span>
        {% elif keyword.rank_diff_from_last_time != 0 %}
            <span class="flex items-center justify-center gap-1">
                {% if keyword.rank_diff_from_last_time > 0 %}
                    <i class="fas fa-arrow-up text-xs rank-change-up"></i>
                    <span class="text-sm font-semibold rank-change-up">+{{ keyword.rank_diff_from_last_time }}</span>
                {% else %}
                    <i class="fas fa-arrow-down text-xs rank-change-down"></i>
                    <span class="text-sm font-semibold rank-change-down">{{ keyword.rank_diff_from_last_time }}</span>
                {% endif %}
            </span>
        {% else %}
            <span class="text-base-content/40">-</span>
        {% endif %}
    </td>
    <td>
        {% load country_flags %}
        <span class="badge badge-ghost" title="Search location: {{ keyword.country|google_domain }}">
            {{ keyword.country|country_flag }} {{ keyword.country }}
        </span>
    </td>
    <td>
        <span class="text-sm">{{ keyword.scraped_at|time_hours_only }}</span>
    </td>
    <td class="text-right">
        <div class="dropdown dropdown-end">
            <button tabindex="0" class="btn btn-ghost btn-sm">
                <i class="fas fa-ellipsis-v"></i>
            </button>
            <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52 border">
                <li>
                    <a href="{% url 'keywords:keyword_detail' keyword.id %}">
                        <i class="fas fa-eye"></i>
                        View Details
                    </a>
                </li>
                <li>
                    <button 
                        hx-post="{% url 'keywords:api_force_crawl' keyword.id %}"
                        hx-trigger="click"
                        hx-swap="none"
                        hx-on::after-request="handleRecheckResponse(event)"
                    >
                        <i class="fas fa-sync"></i>
                        Re-Check Rank
                    </button>
                </li>
                <li>
                    <button onclick="deleteKeyword({{ keyword.id }}, '{{ keyword.keyword|escapejs }}')" class="text-error w-full text-left">
                        <i class="fas fa-trash"></i>
                        Delete
                    </button>
                </li>
            </ul>
        </div>
    </td>
</tr>
{% empty %}
<tr>
    <td colspan="7" class="text-center py-8">
        <i class="fas fa-search text-4xl text-base-content/20 mb-4"></i>
        <p class="text-base-content/60">No keywords found matching your criteria.</p>
    </td>
</tr>
{% endfor %}