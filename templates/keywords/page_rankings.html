{% extends "dashboard_base.html" %}
{% load static %}

{% block title %}Page Rankings - LimeClicks{% endblock %}
{% block page_title %}Page Rankings{% endblock %}

{% block extra_css %}
<style>
    .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 1rem;
        padding: 1.5rem;
        position: relative;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
    }
    
    .metric-card.card-blue {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .metric-card.card-green {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }
    
    .metric-card.card-orange {
        background: linear-gradient(135deg, #fc5c7d 0%, #fd8b47 100%);
    }
    
    .metric-card::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        transform: rotate(45deg);
    }
    
    .metric-icon {
        width: 48px;
        height: 48px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
    }
    
    .metric-icon i {
        font-size: 1.5rem;
        color: white;
    }
    
    .metric-value {
        font-size: 2.5rem;
        font-weight: 800;
        line-height: 1;
        color: white;
        margin-bottom: 0.5rem;
    }
    
    .metric-label {
        font-size: 0.875rem;
        color: rgba(255, 255, 255, 0.9);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .metric-change {
        position: absolute;
        top: 1.5rem;
        right: 1.5rem;
        padding: 0.25rem 0.75rem;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 9999px;
        font-size: 0.75rem;
        color: white;
        font-weight: 600;
    }
    
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
    }
    
    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 16px;
    }
    
    .empty-state h3 {
        font-size: 1.125rem;
        font-weight: 600;
        color: #111827;
        margin-bottom: 8px;
    }
    
    .empty-state p {
        color: #6b7280;
    }
    
    .loading-skeleton {
        background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 4px;
    }
    
    @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    
    .skeleton-row {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 16px;
    }
    
    .skeleton-title {
        height: 20px;
        width: 30%;
        margin-bottom: 12px;
    }
    
    .skeleton-url {
        height: 16px;
        width: 50%;
        margin-bottom: 16px;
    }
    
    .skeleton-metrics {
        display: flex;
        gap: 24px;
    }
    
    .skeleton-metric {
        height: 20px;
        width: 100px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Header -->
    <div class="mb-4">
        <p class="text-gray-600">Analyze which pages rank for the most keywords</p>
    </div>
    
    <!-- Metrics Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
        <!-- Total Pages Card -->
        <div class="metric-card card-blue">
            <div class="metric-icon">
                <i class="fas fa-file-alt"></i>
            </div>
            <div class="metric-value" id="totalPages">0</div>
            <div class="metric-label">Total Pages</div>
        </div>
        
        <!-- Total Keywords Card -->
        <div class="metric-card card-green">
            <div class="metric-icon">
                <i class="fas fa-key"></i>
            </div>
            <div class="metric-value" id="totalKeywords">0</div>
            <div class="metric-label">Total Keywords</div>
        </div>
        
        <!-- Average Position Card -->
        <div class="metric-card card-orange">
            <div class="metric-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="metric-value">#<span id="avgPosition">0</span></div>
            <div class="metric-label">Average Position</div>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="bg-white rounded-lg p-4 mb-6 border border-gray-200">
        <form hx-get="{% url 'keywords:page_rankings_data' %}"
              hx-target="#pagesContainer"
              hx-trigger="change from:find select, keyup delay:500ms from:find input[type='text']"
              hx-indicator="#loadingIndicator">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Search -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Search Pages</label>
                    <input type="text" 
                           name="search"
                           placeholder="Search by URL or keyword..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <!-- Project Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Filter by Project</label>
                    <select name="project" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">All Projects</option>
                        {% for project in projects %}
                        <option value="{{ project.id }}" {% if project.id|stringformat:"s" == selected_project_id %}selected{% endif %}>
                            {{ project.domain }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Items per page -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Items Per Page</label>
                    <select name="per_page" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="25">25</option>
                        <option value="50" selected>50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>
        </form>
    </div>
    
    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="htmx-indicator text-center py-4">
        <div class="inline-flex items-center">
            <svg class="animate-spin h-5 w-5 mr-3 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Loading...
        </div>
    </div>
    
    <!-- Pages Container -->
    <div id="pagesContainer" 
         hx-get="{% url 'keywords:page_rankings_data' %}" 
         hx-trigger="load"
         hx-indicator="#loadingIndicator">
        <!-- Loading skeleton -->
        <div class="skeleton-row">
            <div class="loading-skeleton skeleton-title"></div>
            <div class="loading-skeleton skeleton-url"></div>
            <div class="skeleton-metrics">
                <div class="loading-skeleton skeleton-metric"></div>
                <div class="loading-skeleton skeleton-metric"></div>
                <div class="loading-skeleton skeleton-metric"></div>
            </div>
        </div>
        <div class="skeleton-row">
            <div class="loading-skeleton skeleton-title"></div>
            <div class="loading-skeleton skeleton-url"></div>
            <div class="skeleton-metrics">
                <div class="loading-skeleton skeleton-metric"></div>
                <div class="loading-skeleton skeleton-metric"></div>
                <div class="loading-skeleton skeleton-metric"></div>
            </div>
        </div>
    </div>
</div>

<!-- Keywords Detail Modal (DaisyUI) -->
<dialog id="keywordsModal" class="modal">
    <div class="modal-box max-w-4xl">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
        </form>
        <h3 class="font-bold text-lg mb-4" id="modalTitle">Page Keywords</h3>
        <div id="modalBody">
            <!-- Content loaded via HTMX -->
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>
{% endblock %}

{% block extra_js %}
<script>
    // HTMX will execute scripts in the response, so modal opening is handled there
    // This is just for debugging
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Page Rankings: Ready');
        
        // Debug logging for HTMX events
        document.body.addEventListener('htmx:afterSwap', function(event) {
            console.log('HTMX afterSwap:', event.detail.target?.id);
        });
    });
    
    // Global function to open modal (can be called from response)
    window.openKeywordsModal = function() {
        const modal = document.getElementById('keywordsModal');
        if (modal) {
            modal.showModal();
            console.log('Modal opened');
        }
    }
    
    // Close modal handler
    function closeModal() {
        const modalElement = document.getElementById('keywordsModal');
        if (modalElement) {
            modalElement.close();
        }
    }
</script>
{% endblock %}