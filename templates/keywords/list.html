{% extends "dashboard_base.html" %}
{% load static %}

{% block title %}Keywords - LimeClicks{% endblock %}
{% block page_title %}Keywords{% endblock %}

{% block extra_head %}
<style>
    .keyword-card {
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .keyword-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .loading-spinner {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    .rank-badge {
        min-width: 2.5rem;
        text-align: center;
    }
    
    .rank-up {
        color: #10b981;
    }
    
    .rank-down {
        color: #ef4444;
    }
    
    .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
    }
    
    @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header Section -->
    <div class="mb-8">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-3xl font-bold text-base-content">Keywords</h1>
                <p class="text-base-content/60 mt-1">Track your keyword rankings and SEO performance</p>
            </div>
            <button onclick="location.reload()" class="btn btn-circle btn-ghost">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
        
        <!-- Search and Filter Card -->
        <div class="card bg-base-100 shadow-sm border border-base-300">
            <div class="card-body p-4">
                <!-- Search Bar -->
                <div class="relative mb-4">
                    <input 
                        type="text" 
                        id="search-input"
                        name="search"
                        placeholder="Search keywords, domains, or projects..." 
                        class="input input-bordered w-full pl-12 pr-4 h-12"
                        value="{{ search_query }}"
                        hx-get="{% url 'keywords:list' %}"
                        hx-trigger="keyup changed delay:500ms"
                        hx-target="#keyword-list"
                        hx-swap="innerHTML"
                        hx-vals='{"filter": "{{ filter_status|default:"all" }}"}'
                        hx-indicator="#search-spinner"
                    >
                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-base-content/40"></i>
                    <span id="search-spinner" class="htmx-indicator absolute right-4 top-1/2 -translate-y-1/2">
                        <i class="fas fa-spinner loading-spinner text-primary"></i>
                    </span>
                </div>
                
                <!-- Filter Buttons -->
                <div class="flex items-center gap-2 flex-wrap">
                    <span class="text-sm text-base-content/60 mr-2">Filter:</span>
                    
                    <!-- All Filter (default) -->
                    <button 
                        type="button"
                        name="filter"
                        value="all"
                        class="btn btn-sm {% if filter_status == 'all' or not filter_status %}btn-primary{% else %}btn-outline{% endif %}"
                        hx-get="{% url 'keywords:list' %}"
                        hx-trigger="click"
                        hx-target="#keyword-list"
                        hx-swap="innerHTML"
                        hx-include="#search-input"
                        hx-vals='{"filter": "all"}'
                        onclick="updateFilterButtons(this)"
                    >
                        All
                        <span class="badge badge-sm ml-1">{{ total_keywords }}</span>
                    </button>
                    
                    <!-- Top 10 Filter -->
                    <button 
                        type="button"
                        name="filter"
                        value="top10"
                        class="btn btn-sm {% if filter_status == 'top10' %}btn-success{% else %}btn-outline btn-success{% endif %}"
                        hx-get="{% url 'keywords:list' %}"
                        hx-trigger="click"
                        hx-target="#keyword-list"
                        hx-swap="innerHTML"
                        hx-include="#search-input"
                        hx-vals='{"filter": "top10"}'
                        onclick="updateFilterButtons(this)"
                    >
                        <i class="fas fa-trophy mr-1"></i>
                        Top 10
                        <span class="badge badge-sm ml-1">{{ top10_count }}</span>
                    </button>
                    
                    <!-- Improved Filter -->
                    <button 
                        type="button"
                        name="filter"
                        value="improved"
                        class="btn btn-sm {% if filter_status == 'improved' %}btn-info{% else %}btn-outline btn-info{% endif %}"
                        hx-get="{% url 'keywords:list' %}"
                        hx-trigger="click"
                        hx-target="#keyword-list"
                        hx-swap="innerHTML"
                        hx-include="#search-input"
                        hx-vals='{"filter": "improved"}'
                        onclick="updateFilterButtons(this)"
                    >
                        <i class="fas fa-arrow-up mr-1"></i>
                        Improved
                        <span class="badge badge-sm ml-1">{{ improved_count }}</span>
                    </button>
                    
                    <!-- Declined Filter -->
                    <button 
                        type="button"
                        name="filter"
                        value="declined"
                        class="btn btn-sm {% if filter_status == 'declined' %}btn-warning{% else %}btn-outline btn-warning{% endif %}"
                        hx-get="{% url 'keywords:list' %}"
                        hx-trigger="click"
                        hx-target="#keyword-list"
                        hx-swap="innerHTML"
                        hx-include="#search-input"
                        hx-vals='{"filter": "declined"}'
                        onclick="updateFilterButtons(this)"
                    >
                        <i class="fas fa-arrow-down mr-1"></i>
                        Declined
                        <span class="badge badge-sm ml-1">{{ declined_count }}</span>
                    </button>
                    
                    <!-- Not Ranking Filter -->
                    <button 
                        type="button"
                        name="filter"
                        value="not_ranking"
                        class="btn btn-sm {% if filter_status == 'not_ranking' %}btn-error{% else %}btn-outline btn-error{% endif %}"
                        hx-get="{% url 'keywords:list' %}"
                        hx-trigger="click"
                        hx-target="#keyword-list"
                        hx-swap="innerHTML"
                        hx-include="#search-input"
                        hx-vals='{"filter": "not_ranking"}'
                        onclick="updateFilterButtons(this)"
                    >
                        <i class="fas fa-times-circle mr-1"></i>
                        Not Ranking
                        <span class="badge badge-sm ml-1">{{ not_ranking_count }}</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
        <!-- Total Keywords Card -->
        <div class="card bg-base-100 shadow-sm border border-base-300">
            <div class="card-body p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-base-content/60 text-sm">Total Keywords</p>
                        <p class="text-2xl font-bold text-base-content" data-stat="total">{{ total_keywords }}</p>
                    </div>
                    <div class="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                        <i class="fas fa-key text-primary text-lg"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Top 10 Card -->
        <div class="card bg-base-100 shadow-sm border border-base-300">
            <div class="card-body p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-base-content/60 text-sm">Top 10</p>
                        <p class="text-2xl font-bold text-success">{{ top10_count }}</p>
                    </div>
                    <div class="w-12 h-12 bg-success/10 rounded-lg flex items-center justify-center">
                        <i class="fas fa-trophy text-success text-lg"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Improved Card -->
        <div class="card bg-base-100 shadow-sm border border-base-300">
            <div class="card-body p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-base-content/60 text-sm">Improved</p>
                        <p class="text-2xl font-bold text-info">{{ improved_count }}</p>
                    </div>
                    <div class="w-12 h-12 bg-info/10 rounded-lg flex items-center justify-center">
                        <i class="fas fa-arrow-up text-info text-lg"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Declined Card -->
        <div class="card bg-base-100 shadow-sm border border-base-300">
            <div class="card-body p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-base-content/60 text-sm">Declined</p>
                        <p class="text-2xl font-bold text-warning">{{ declined_count }}</p>
                    </div>
                    <div class="w-12 h-12 bg-warning/10 rounded-lg flex items-center justify-center">
                        <i class="fas fa-arrow-down text-warning text-lg"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Not Ranking Card -->
        <div class="card bg-base-100 shadow-sm border border-base-300">
            <div class="card-body p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-base-content/60 text-sm">Not Ranking</p>
                        <p class="text-2xl font-bold text-error">{{ not_ranking_count }}</p>
                    </div>
                    <div class="w-12 h-12 bg-error/10 rounded-lg flex items-center justify-center">
                        <i class="fas fa-times-circle text-error text-lg"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Keyword List -->
    <div id="keyword-list">
        <div class="grid grid-cols-1 gap-4" id="keyword-cards-container">
            {% if projects_with_keywords %}
                {% for item in projects_with_keywords %}
                    {% include "keywords/partials/keyword_project_card.html" %}
                {% endfor %}
            {% else %}
                <!-- Empty State -->
                {% include "keywords/partials/empty_state.html" %}
            {% endif %}
        </div>
        
        {% if page_obj.paginator.num_pages > 1 %}
        <!-- Pagination Controls -->
        <div class="card bg-base-100 shadow-sm border border-base-300 mt-8">
            <div class="card-body p-4">
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <!-- Page Info -->
                    <div class="text-sm text-base-content/60">
                        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                    </div>
                    
                    <!-- Pagination Controls -->
                    <div class="join">
                        {% if page_obj.has_previous %}
                        <a 
                            class="join-item btn btn-sm"
                            href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}"
                            hx-get="{% url 'keywords:list' %}?page=1{% if search_query %}&search={{ search_query }}{% endif %}"
                            hx-target="#keyword-list"
                            hx-swap="innerHTML"
                            hx-push-url="true"
                        >
                            «
                        </a>
                        <a 
                            class="join-item btn btn-sm"
                            href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}"
                            hx-get="{% url 'keywords:list' %}?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}"
                            hx-target="#keyword-list"
                            hx-swap="innerHTML"
                            hx-push-url="true"
                        >
                            ‹
                        </a>
                        {% else %}
                        <button class="join-item btn btn-sm btn-disabled" disabled>«</button>
                        <button class="join-item btn btn-sm btn-disabled" disabled>‹</button>
                        {% endif %}
                        
                        <!-- Page Numbers -->
                        {% for num in page_obj.paginator.page_range %}
                            {% if num > page_obj.number|add:"-3" and num < page_obj.number|add:"3" %}
                            {% if page_obj.number == num %}
                            <button class="join-item btn btn-sm btn-active" disabled>
                                {{ num }}
                            </button>
                            {% else %}
                            <a 
                                class="join-item btn btn-sm"
                                href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}"
                                hx-get="{% url 'keywords:list' %}?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}"
                                hx-target="#keyword-list"
                                hx-swap="innerHTML"
                                hx-push-url="true"
                            >
                                {{ num }}
                            </a>
                            {% endif %}
                            {% endif %}
                        {% endfor %}
                        
                        {% if page_obj.has_next %}
                        <a 
                            class="join-item btn btn-sm"
                            href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}"
                            hx-get="{% url 'keywords:list' %}?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}"
                            hx-target="#keyword-list"
                            hx-swap="innerHTML"
                            hx-push-url="true"
                        >
                            ›
                        </a>
                        <a 
                            class="join-item btn btn-sm"
                            href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}"
                            hx-get="{% url 'keywords:list' %}?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}"
                            hx-target="#keyword-list"
                            hx-swap="innerHTML"
                            hx-push-url="true"
                        >
                            »
                        </a>
                        {% else %}
                        <button class="join-item btn btn-sm btn-disabled" disabled>›</button>
                        <button class="join-item btn btn-sm btn-disabled" disabled>»</button>
                        {% endif %}
                    </div>
                    
                    <!-- Results Info -->
                    <div class="text-sm text-base-content/60">
                        Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} projects
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal Container for HTMX -->
<div id="modal-container"></div>

<!-- JavaScript for interactions -->
<script>
    // Function to update filter button styles
    function updateFilterButtons(clickedBtn) {
        // Remove filled state from all filter buttons
        document.querySelectorAll('[name="filter"]').forEach(btn => {
            btn.classList.remove('btn-primary', 'btn-success', 'btn-info', 'btn-warning', 'btn-error');
            
            // Add outline style based on button type
            if (btn.textContent.includes('Top 10')) {
                btn.classList.add('btn-outline', 'btn-success');
            } else if (btn.textContent.includes('Improved')) {
                btn.classList.add('btn-outline', 'btn-info');
            } else if (btn.textContent.includes('Declined')) {
                btn.classList.add('btn-outline', 'btn-warning');
            } else if (btn.textContent.includes('Not Ranking')) {
                btn.classList.add('btn-outline', 'btn-error');
            } else if (btn.textContent.includes('All')) {
                btn.classList.add('btn-outline');
            }
        });
        
        // Add filled state to clicked button
        clickedBtn.classList.remove('btn-outline');
        if (clickedBtn.value === 'top10') {
            clickedBtn.classList.add('btn-success');
        } else if (clickedBtn.value === 'improved') {
            clickedBtn.classList.add('btn-info');
        } else if (clickedBtn.value === 'declined') {
            clickedBtn.classList.add('btn-warning');
        } else if (clickedBtn.value === 'not_ranking') {
            clickedBtn.classList.add('btn-error');
        } else {
            clickedBtn.classList.add('btn-primary');
        }
    }
    
    // Handle search input and other initialization
    document.addEventListener('DOMContentLoaded', function() {
        // Handle search input
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.addEventListener('input', function(e) {
                // Update URL parameter without reload
                const url = new URL(window.location);
                if (e.target.value) {
                    url.searchParams.set('search', e.target.value);
                } else {
                    url.searchParams.delete('search');
                }
                window.history.replaceState({}, '', url);
            });
        }
    });
    
    // Listen for HTMX events
    document.body.addEventListener('keywordsAdded', function(evt) {
        // Show success notification
        const notification = document.createElement('div');
        notification.className = 'alert alert-success fixed top-20 right-4 z-50 shadow-lg max-w-sm';
        notification.innerHTML = `
            <i class="fas fa-check-circle"></i>
            <span>Keywords added successfully!</span>
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
        
        // Update statistics
        const totalElement = document.querySelector('[data-stat="total"]');
        if (totalElement) {
            // Reload the page to get updated stats
            setTimeout(() => {
                location.reload();
            }, 1000);
        }
    });
</script>
{% endblock %}