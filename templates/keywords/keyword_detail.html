{% extends "dashboard_base.html" %}
{% load static %}
{% load country_flags %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }
    
    /* Ensure SERP tab is visible by default */
    #serp-results {
        display: block !important;
    }
    #serp-results.hidden {
        display: none !important;
    }
    
    /* Custom scrollbar for SERP results */
    .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 4px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 4px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.5);
    }
    
    .stat-card {
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .serp-result {
        transition: all 0.2s ease;
    }
    
    .serp-result:hover {
        background-color: var(--fallback-b2, oklch(var(--b2)));
    }
    
    .rank-badge {
        min-width: 3rem;
        text-align: center;
        font-weight: bold;
    }
    
    /* Green for ranks 1-10 */
    .rank-1, .rank-2, .rank-3, .rank-top10 { 
        background-color: #10b981; 
        color: white; 
    }
    
    /* Yellow for ranks 11-50 */
    .rank-top30, .rank-top50 { 
        background-color: #f59e0b; 
        color: white; 
    }
    
    /* Red for ranks 51+ and NR */
    .rank-top100, .rank-none { 
        background-color: #ef4444; 
        color: white; 
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header with Back Button -->
    <div class="mb-8">
        <div class="flex items-center gap-4 mb-6">
            <a href="{% url 'keywords:project_keywords' project.id %}" class="btn btn-ghost btn-circle">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div class="flex-1">
                <h1 class="text-3xl font-bold text-base-content">{{ keyword.keyword }}</h1>
                <div class="flex items-center gap-4 mt-2">
                    <span class="text-base-content/60" title="{{ keyword.country }}">
                        <i class="fas fa-globe mr-1"></i>{{ keyword.country|country_with_flag }}
                    </span>
                    <span class="text-base-content/60">
                        <i class="fas fa-folder mr-1"></i>{{ project.name|default:project.domain }}
                    </span>
                    {% if keyword.rank > 0 and keyword.rank <= 100 %}
                    <span class="badge rank-badge {% if keyword.rank == 1 %}rank-1{% elif keyword.rank == 2 %}rank-2{% elif keyword.rank == 3 %}rank-3{% elif keyword.rank <= 10 %}rank-top10{% elif keyword.rank <= 30 %}rank-top30{% elif keyword.rank <= 50 %}rank-top50{% else %}rank-top100{% endif %}">
                        #{{ keyword.rank }}
                    </span>
                    {% else %}
                    <span class="badge rank-badge rank-none">NR</span>
                    {% endif %}
                </div>
            </div>
            <div class="flex gap-2">
                <button 
                    class="btn btn-primary"
                    hx-post="{% url 'keywords:api_force_crawl' keyword.id %}"
                    hx-trigger="click"
                    hx-swap="none"
                    hx-on::after-request="handleRecheckResponse(event)"
                >
                    <i class="fas fa-sync mr-2"></i>
                    Re-Check Rank
                </button>
                <button class="btn btn-ghost">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Stats Cards -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
        <div class="stat-card card bg-base-100 shadow-sm border border-base-300">
            <div class="card-body p-4">
                <p class="text-base-content/60 text-xs">Current Rank</p>
                <p class="text-2xl font-bold">
                    {% if keyword.rank > 0 and keyword.rank <= 100 %}
                        #{{ keyword.rank }}
                    {% else %}
                        NR
                    {% endif %}
                </p>
            </div>
        </div>
        
        <div class="stat-card card bg-base-100 shadow-sm border border-base-300">
            <div class="card-body p-4">
                <p class="text-base-content/60 text-xs">Best Rank</p>
                <p class="text-2xl font-bold text-success">
                    {% if best_rank > 0 and best_rank <= 100 %}#{{ best_rank }}{% else %}NR{% endif %}
                </p>
            </div>
        </div>
        
        <div class="stat-card card bg-base-100 shadow-sm border border-base-300">
            <div class="card-body p-4">
                <p class="text-base-content/60 text-xs">Average Rank</p>
                <p class="text-2xl font-bold">
                    {% if avg_rank > 0 and avg_rank <= 100 %}#{{ avg_rank|floatformat:0 }}{% else %}NR{% endif %}
                </p>
            </div>
        </div>
        
        <div class="stat-card card bg-base-100 shadow-sm border border-base-300">
            <div class="card-body p-4">
                <p class="text-base-content/60 text-xs">Total Checks</p>
                <p class="text-2xl font-bold">{{ total_checks }}</p>
            </div>
        </div>
        
        <div class="stat-card card bg-base-100 shadow-sm border border-base-300">
            <div class="card-body p-4">
                <p class="text-base-content/60 text-xs">Last Checked</p>
                <p class="text-sm font-bold">
                    {% if keyword.scraped_at %}
                        {{ keyword.scraped_at|timesince }} ago
                    {% else %}
                        Never
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    
    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Ranking History Chart -->
        <div class="card bg-base-100 shadow-sm border border-base-300">
            <div class="card-body">
                <h2 class="card-title mb-4">Ranking History</h2>
                <div class="chart-container">
                    <canvas id="rankingChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Search Volume Chart (Placeholder) -->
        <div class="card bg-base-100 shadow-sm border border-base-300">
            <div class="card-body">
                <h2 class="card-title mb-4">Search Volume Analysis</h2>
                <div class="chart-container">
                    <canvas id="volumeChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tabs Section -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body p-0">
            <div class="tabs tabs-boxed bg-base-200 p-1">
                <button type="button" class="tab tab-active" onclick="showTab(event, 'serp-results')">
                    <i class="fas fa-list mr-2"></i>SERP Results
                </button>
                <button type="button" class="tab" onclick="showTab(event, 'history')">
                    <i class="fas fa-history mr-2"></i>History
                </button>
            </div>
            
            <!-- SERP Results Tab (visible by default) -->
            <div id="serp-results" class="tab-content p-6">
                <h3 class="text-lg font-semibold mb-4">
                    Top Search Results
                </h3>
                
                {% if local_pack_results %}
                <!-- Local Pack Results -->
                <div class="mb-6">
                    <h4 class="text-md font-semibold mb-3 flex items-center">
                        <i class="fas fa-map-marker-alt mr-2 text-primary"></i>
                        Local Pack Results
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        {% for local in local_pack_results %}
                        <div class="card bg-base-100 border border-base-300 p-4">
                            <div class="font-medium">{{ local.title }}</div>
                            {% if local.rating %}
                            <div class="flex items-center gap-1 mt-1">
                                <span class="text-yellow-500">★</span>
                                <span class="text-sm">{{ local.rating }}</span>
                                {% if local.reviews %}
                                <span class="text-xs text-base-content/60">({{ local.reviews }} reviews)</span>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% if local.address %}
                            <div class="text-xs text-base-content/60 mt-1">{{ local.address }}</div>
                            {% endif %}
                            {% if local.website %}
                            <a href="{{ local.website }}" target="_blank" class="text-xs text-primary hover:underline mt-1">
                                Visit website
                            </a>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% if serp_results %}
                <!-- Organic Results with Scrolling -->
                <div class="max-h-[600px] overflow-y-auto pr-2 space-y-3 custom-scrollbar">
                    {% for result in serp_results %}
                    <div class="serp-result p-4 rounded-lg border {% if result.is_own_site %}border-primary-focus border-2 bg-primary/10 shadow-lg{% else %}border-base-300{% endif %}">
                        <div class="flex items-start gap-4">
                            <span class="badge badge-lg {% if result.is_own_site %}badge-primary{% endif %}">
                                {{ result.position|default:forloop.counter }}
                            </span>
                            <div class="flex-1">
                                {% if result.is_own_site %}
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="badge badge-primary badge-sm">
                                        <i class="fas fa-star mr-1"></i>YOUR SITE
                                    </span>
                                    <span class="text-xs text-primary font-semibold">{{ keyword.project.domain }}</span>
                                </div>
                                {% endif %}
                                {% if result.url and result.url != '#' %}
                                <a href="{{ result.url }}" target="_blank" class="text-primary font-medium hover:underline {% if result.is_own_site %}text-lg font-bold{% endif %}">
                                    {{ result.title }}
                                </a>
                                <div class="text-sm text-base-content/60 mt-1">{{ result.url|truncatechars:80 }}</div>
                                {% else %}
                                <!-- This shouldn't happen with the new filtering, but keep as fallback -->
                                <span class="font-medium">{{ result.title }}</span>
                                <div class="text-sm text-base-content/60 mt-1">
                                    <span class="badge badge-ghost badge-sm">Special Result</span>
                                </div>
                                {% endif %}
                                {% if result.snippet %}
                                <div class="text-sm mt-2 {% if result.is_own_site %}text-base-content{% else %}text-base-content/80{% endif %}">
                                    {{ result.snippet|truncatechars:200 }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8 text-base-content/60">
                    <i class="fas fa-search text-4xl mb-4"></i>
                    <p>No SERP data available yet.</p>
                    <p class="text-sm mt-2">Run a crawl to see search results.</p>
                </div>
                {% endif %}
            </div>
            
            <!-- History Tab -->
            <div id="history" class="tab-content p-6 hidden">
                <h3 class="text-lg font-semibold mb-4">
                    Complete Ranking History 
                    <span class="text-sm text-base-content/60">({{ ranking_history|length }} checks)</span>
                    <!-- Debug button -->
                    <button onclick="viewHistoricalSERP(796, 'Sep 04, 2025 00:00', 4)" class="btn btn-sm btn-primary ml-4">
                        Test SERP (Rank 796)
                    </button>
                </h3>
                {% if ranking_history %}
                <div class="max-h-[600px] overflow-y-auto custom-scrollbar">
                    <div class="space-y-3">
                        {% for history in ranking_history %}
                        <div class="card bg-base-100 border border-base-300 p-4 hover:shadow-lg transition-shadow">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <!-- Date and Time -->
                                    <div>
                                        <div class="text-sm font-semibold">{{ history.created_at|date:"M d, Y" }}</div>
                                        <div class="text-xs text-base-content/60">{{ history.created_at|date:"H:i" }}</div>
                                    </div>
                                    
                                    <!-- Rank Badge -->
                                    <div>
                                        {% if history.rank > 0 and history.rank <= 100 %}
                                            <span class="badge badge-lg {% if history.rank <= 3 %}badge-success{% elif history.rank <= 10 %}badge-warning{% elif history.rank <= 30 %}badge-info{% else %}badge-ghost{% endif %}">
                                                #{{ history.rank }}
                                            </span>
                                        {% else %}
                                            <span class="badge badge-lg badge-ghost">NR</span>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Change Indicator -->
                                    <div class="min-w-[80px]">
                                        {% if history.rank_change != 0 %}
                                            {% if history.rank_change > 0 %}
                                                <span class="text-success font-semibold">
                                                    <i class="fas fa-arrow-up mr-1"></i>+{{ history.rank_change }}
                                                </span>
                                            {% else %}
                                                <span class="text-error font-semibold">
                                                    <i class="fas fa-arrow-down mr-1"></i>{{ history.rank_change }}
                                                </span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-base-content/40">—</span>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- SERP Data Indicator -->
                                    <div>
                                        {% if history.search_results_file %}
                                        <span class="badge badge-ghost badge-sm">
                                            <i class="fas fa-database mr-1"></i>SERP Data
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Actions -->
                                <div class="flex items-center gap-2">
                                    {% if history.search_results_file %}
                                    <button onclick="viewHistoricalSERP({{ history.id }}, '{{ history.created_at|date:'M d, Y H:i' }}', {{ history.rank }})" 
                                            class="btn btn-primary btn-sm">
                                        <i class="fas fa-eye mr-1"></i>View SERP
                                    </button>
                                    {% else %}
                                    <span class="text-xs text-base-content/40">No SERP data</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% else %}
                <div class="text-center py-8 text-base-content/60">
                    <i class="fas fa-history text-4xl mb-4"></i>
                    <p>No historical data available yet.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal for Historical SERP Data -->
<div id="historicalSerpModal" class="modal">
    <div class="modal-box max-w-5xl">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
        </form>
        <h3 class="font-bold text-lg mb-4">
            <span id="modalTitle">Historical SERP Results</span>
        </h3>
        <div id="modalContent" class="max-h-[600px] overflow-y-auto">
            <div class="text-center py-8">
                <span class="loading loading-spinner loading-lg"></span>
                <p class="mt-2">Loading SERP data...</p>
            </div>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</div>

<script>
// Handle Re-Check Rank response
function handleRecheckResponse(event) {
    const response = event.detail.xhr.response;
    try {
        const data = JSON.parse(response);
        if (data.success) {
            // Show success message
            showNotification('Rank re-check initiated successfully. Page will refresh when complete.', 'success');
            // Update the button to show processing state
            const button = event.target;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Checking...';
            
            // Reload the page after 10 seconds to show updated data
            setTimeout(() => {
                window.location.reload();
            }, 10000);
            
            // Also start polling for faster updates
            pollForUpdates({{ keyword.id }});
            
        } else {
            // Show error message
            showNotification(data.message || 'Unable to re-check rank. Please try again later.', 'error');
        }
    } catch (e) {
        showNotification('An error occurred. Please try again.', 'error');
    }
}

// Poll for keyword updates
function pollForUpdates(keywordId) {
    let pollCount = 0;
    const maxPolls = 30; // Poll for max 30 seconds
    
    const pollInterval = setInterval(() => {
        fetch(`/keywords/api/keyword/${keywordId}/status/`)
            .then(response => response.json())
            .then(data => {
                if (data.success && !data.processing) {
                    // Update has completed
                    clearInterval(pollInterval);
                    updateKeywordDisplay(data);
                    showNotification('Rank check completed!', 'success');
                } else if (pollCount >= maxPolls) {
                    // Stop polling after max attempts
                    clearInterval(pollInterval);
                }
                pollCount++;
            })
            .catch(error => {
                console.error('Polling error:', error);
                clearInterval(pollInterval);
            });
    }, 1000); // Poll every second
}

// Update the keyword display with new data
function updateKeywordDisplay(data) {
    console.log('Updating display with data:', data);
    
    // Update current rank with change indicator
    const currentRankCard = document.querySelector('.stat-card:first-child');
    if (currentRankCard) {
        const rankElement = currentRankCard.querySelector('.text-3xl');
        if (rankElement) {
            let rankHtml = '';
            if (data.rank > 0 && data.rank <= 100) {
                rankHtml = `#${data.rank}`;
                rankElement.className = 'text-3xl font-bold text-success';
            } else {
                rankHtml = 'NR';
                rankElement.className = 'text-3xl font-bold text-error';
            }
            
            // Add change indicator if rank changed
            if (data.rank_change && data.rank_change !== 0) {
                if (data.rank_change > 0) {
                    rankHtml += ` <span class="text-sm text-success">↑${Math.abs(data.rank_change)}</span>`;
                } else {
                    rankHtml += ` <span class="text-sm text-error">↓${Math.abs(data.rank_change)}</span>`;
                }
            }
            rankElement.innerHTML = rankHtml;
        }
    }
    
    // Update best rank if needed
    const bestRankElement = document.querySelector('.stat-card:nth-child(2) .text-2xl');
    if (bestRankElement && data.best_rank !== undefined) {
        if (data.best_rank > 0 && data.best_rank <= 100) {
            bestRankElement.innerHTML = `#${data.best_rank}`;
        } else {
            bestRankElement.innerHTML = 'NR';
        }
    }
    
    // Update last checked time
    const lastCheckedElement = document.querySelector('.stat-card:last-child .text-2xl');
    if (lastCheckedElement && data.time_since) {
        if (data.time_since === 'Never') {
            lastCheckedElement.innerHTML = 'Never';
        } else {
            lastCheckedElement.innerHTML = 'Just now';
        }
    }
    
    // Show completion notification with rank change info
    let message = 'Rank check completed! ';
    if (data.rank_change && data.rank_change !== 0) {
        if (data.rank_change > 0) {
            message += `Rank improved by ${Math.abs(data.rank_change)} positions!`;
        } else {
            message += `Rank dropped by ${Math.abs(data.rank_change)} positions.`;
        }
    } else {
        message += 'No rank change.';
    }
    showNotification(message, data.rank_change > 0 ? 'success' : 'info');
    
    // Refresh the page after a short delay to update all data (charts, SERP results, etc.)
    setTimeout(() => {
        window.location.reload();
    }, 3000);
}

// Show notification
function showNotification(message, type = 'info') {
    // Create toast notification
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'error' : 'info'} fixed top-4 right-4 z-50 max-w-sm shadow-lg`;
    toast.innerHTML = `
        <div>
            <span>${message}</span>
        </div>
    `;
    document.body.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        toast.remove();
    }, 5000);
}

// Function to view historical SERP data
function viewHistoricalSERP(rankId, date, position) {
    console.log('viewHistoricalSERP called with:', rankId, date, position);
    
    const modal = document.getElementById('historicalSerpModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');
    
    if (!modal) {
        console.error('Modal element not found');
        return;
    }
    
    // Update modal title
    modalTitle.textContent = `SERP Results - ${date} (Rank #${position})`;
    
    // Show modal
    modal.showModal();
    
    // Fetch historical SERP data
    fetch(`/keywords/api/rank/${rankId}/serp/`, {
        credentials: 'same-origin',  // Include cookies for authentication
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            
            if (data.success && data.data && data.data.serp_results) {
                const serpResults = data.data.serp_results;
                const localPack = data.data.local_pack;
                // Build HTML for SERP results
                let html = '<div class="space-y-3">';
                
                // Local Pack
                if (localPack && localPack.length > 0) {
                    html += '<h4 class="font-semibold mb-2">Local Pack Results</h4>';
                    html += '<div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-4">';
                    localPack.forEach(local => {
                        html += `
                            <div class="card bg-base-100 border p-3">
                                <div class="font-medium text-sm">${local.title || local.name}</div>
                                ${local.rating ? `<div class="text-xs">⭐ ${local.rating} (${local.reviews})</div>` : ''}
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                
                // Organic Results
                html += '<h4 class="font-semibold mb-2">Organic Results</h4>';
                html += '<div class="max-h-[500px] overflow-y-auto space-y-2">';
                
                serpResults.forEach(result => {
                    const isOwnSite = result.is_own_site || false;
                    const title = result.title || 'Untitled';
                    const url = result.url || '#';
                    const snippet = result.snippet || '';
                    const position = result.position || 0;
                    
                    html += `
                        <div class="p-3 rounded border ${isOwnSite ? 'border-primary bg-primary/5' : 'border-base-300'}">
                            <div class="flex items-start gap-3">
                                <span class="badge ${isOwnSite ? 'badge-primary' : 'badge-ghost'}">${position}</span>
                                <div class="flex-1">
                                    ${isOwnSite ? '<span class="badge badge-primary badge-sm mb-1">YOUR SITE</span>' : ''}
                                    <div class="font-medium text-sm">${title}</div>
                                    <div class="text-xs text-base-content/60">${url}</div>
                                    ${snippet ? `<div class="text-xs mt-1">${snippet.substring(0, 150)}${snippet.length > 150 ? '...' : ''}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                html += '</div>';
                
                modalContent.innerHTML = html;
            } else {
                console.error('No SERP data in response:', data);
                modalContent.innerHTML = '<div class="text-center py-8 text-base-content/60">No SERP data available for this rank.</div>';
            }
        })
        .catch(error => {
            console.error('Error loading SERP data:', error);
            modalContent.innerHTML = '<div class="text-center py-8 text-error">Failed to load SERP data. Please check the console for details.</div>';
        });
}
</script>

<script>
    // Tab switching
    function showTab(event, tabId) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.add('hidden');
            tab.style.display = ''; // Clear any inline display style
        });
        
        // Show selected tab
        const targetTab = document.getElementById(tabId);
        if (targetTab) {
            targetTab.classList.remove('hidden');
            targetTab.style.display = 'block'; // Force display
        }
        
        // Update tab buttons
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('tab-active');
        });
        if (event && event.currentTarget) {
            event.currentTarget.classList.add('tab-active');
        }
    }
    
    // Wait for page and Chart.js to load
    window.addEventListener('DOMContentLoaded', function() {
        // Ensure SERP Results tab is visible by default
        const serpTab = document.getElementById('serp-results');
        if (serpTab) {
            serpTab.classList.remove('hidden');
        }
        // Hide other tabs
        document.getElementById('history')?.classList.add('hidden');
        // Initialize ranking chart
        const ctx = document.getElementById('rankingChart');
        const chartDates = {{ chart_dates|safe|default:'[]' }};
        const chartRanks = {{ chart_ranks|safe|default:'[]' }};
        
        if (ctx && typeof Chart !== 'undefined') {
            const rankingChart = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
            labels: chartDates.length > 0 ? chartDates : ['No Data'],
            datasets: [{
                label: 'Rank',
                data: chartRanks.length > 0 ? chartRanks : [0],
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.3,
                fill: true,
                pointRadius: chartDates.length === 1 ? 5 : 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let rank = context.parsed.y;
                            if (rank > 100) {
                                return 'Not Ranking';
                            }
                            return 'Rank #' + rank;
                        }
                    }
                }
            },
            scales: {
                y: {
                    reverse: true,
                    beginAtZero: false,
                    min: 1,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            if (value > 100) return 'NR';
                            return '#' + value;
                        }
                    }
                }
            }
        }
    });
        }
        
        // Initialize volume chart (placeholder)
        const volumeCtx = document.getElementById('volumeChart');
        if (volumeCtx && typeof Chart !== 'undefined') {
            const volumeChart = new Chart(volumeCtx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            datasets: [{
                label: 'Search Volume',
                data: [1200, 1900, 3000, 2500, 2700, 3500],
                backgroundColor: 'rgba(16, 185, 129, 0.8)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
        }
    }); // End of DOMContentLoaded
</script>
{% endblock %}