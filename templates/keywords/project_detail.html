{% extends "dashboard_base.html" %}
{% load static %}
{% load country_flags %}

{% block title %}{{ project.name|default:project.domain }} Keywords - LimeClicks{% endblock %}
{% block page_title %}Keywords - {{ project.name|default:project.domain }}{% endblock %}

{% block extra_head %}
<style>
    .keyword-row {
        transition: all 0.2s ease;
    }
    
    .keyword-row:hover {
        background-color: var(--fallback-b2, oklch(var(--b2)));
    }
    
    .rank-badge {
        min-width: 3rem;
        text-align: center;
        font-weight: bold;
    }
    
    /* Green for ranks 1-10 */
    .rank-1 { background-color: #10b981; color: white; }
    .rank-2 { background-color: #10b981; color: white; }
    .rank-3 { background-color: #10b981; color: white; }
    .rank-top10 { background-color: #10b981; color: white; }
    
    /* Yellow for ranks 11-50 */
    .rank-top30 { background-color: #f59e0b; color: white; }
    .rank-top50 { background-color: #f59e0b; color: white; }
    
    /* Red for ranks 51-100 and NR */
    .rank-top100 { background-color: #ef4444; color: white; }
    .rank-none { background-color: #ef4444; color: white; }
    
    .rank-change-up { color: #10b981; }
    .rank-change-down { color: #ef4444; }
    
    .loading-spinner {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    /* Sortable header styles */
    th button {
        background: none;
        border: none;
        padding: 0;
        transition: color 0.2s;
    }
    
    th button:hover {
        color: var(--primary);
    }
    
    .sort-indicator {
        display: inline-flex;
        align-items: center;
        margin-left: 4px;
    }
    
    /* Ensure table columns are always visible - specific to keywords table only */
    #keywords-table table th,
    #keywords-table table td {
        display: table-cell !important;
        visibility: visible !important;
    }
    
    /* Ensure rank cell is visible */
    #keywords-table .rank-cell {
        display: table-cell !important;
        visibility: visible !important;
    }
    
    /* Ensure rank badges in table are visible */
    #keywords-table .rank-badge {
        display: inline-flex !important;
        visibility: visible !important;
    }
    
    /* Ensure tags in keyword table cells are visible */
    #keywords-table tbody td .badge {
        display: inline-flex !important;
        visibility: visible !important;
    }
    
    /* Prevent any hiding of table content based on sidebar state */
    .sidebar-collapsed #keywords-table table th,
    .sidebar-collapsed #keywords-table table td {
        display: table-cell !important;
        visibility: visible !important;
    }
    
    /* Specific fix for rank cell when sidebar is collapsed */
    .sidebar-collapsed #keywords-table .rank-cell {
        display: table-cell !important;
        visibility: visible !important;
    }
    
    /* Override any responsive table behavior */
    @media screen and (max-width: 1280px) {
        #keywords-table table th,
        #keywords-table table td {
            display: table-cell !important;
            visibility: visible !important;
        }
        
        /* Prevent responsive table from hiding columns */
        #keywords-table .overflow-x-auto {
            overflow-x: auto !important;
        }
        
        /* Ensure Current Rank column header and cells are visible */
        #keywords-table table th:nth-child(2),
        #keywords-table table td:nth-child(2) {
            display: table-cell !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
    }
    
    /* Force visibility for Current Rank column in keywords table only */
    #keywords-table table th:nth-child(2),
    #keywords-table table td.rank-cell {
        display: table-cell !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    /* Remove any scroll issues - let overflow-x-auto handle it */
    
    /* Table styles */
    .table {
        width: 100%;
        min-width: 768px; /* Ensure table maintains minimum width */
    }
    
    /* Table header styling */
    .table thead th {
        background: var(--fallback-b1, oklch(var(--b1)));
        border-bottom: 2px solid var(--fallback-b3, oklch(var(--b3)));
        white-space: nowrap;
    }
    
    /* Only show horizontal scrollbar when needed (on mobile) */
    @media (max-width: 768px) {
        .table-container::-webkit-scrollbar {
            height: 8px;
        }
        
        .table-container::-webkit-scrollbar-track {
            background: var(--fallback-b2, oklch(var(--b2)));
            border-radius: 4px;
        }
        
        .table-container::-webkit-scrollbar-thumb {
            background: var(--fallback-bc, oklch(var(--bc) / 0.3));
            border-radius: 4px;
        }
        
        .table-container::-webkit-scrollbar-thumb:hover {
            background: var(--fallback-bc, oklch(var(--bc) / 0.5));
        }
    }
    
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header Section with Back Button -->
    <div class="mb-8">
        <div class="flex items-center gap-4 mb-6">
            <a href="{% url 'keywords:list' %}" class="btn btn-ghost btn-circle">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div class="flex-1">
                <h1 class="text-3xl font-bold text-base-content">{{ project.name|default:project.domain }}</h1>
                <p class="text-base-content/60 mt-1">Track keyword rankings for {{ project.domain }}</p>
            </div>
            <button 
                hx-get="{% url 'keywords:add_keyword_modal' %}?project_id={{ project.id }}"
                hx-trigger="click"
                hx-target="#modal-container"
                hx-swap="innerHTML"
                class="btn btn-primary"
            >
                <i class="fas fa-plus mr-2"></i>
                Add Keywords
            </button>
        </div>
        
        <!-- Search and Filter Card -->
        <div class="card bg-base-100 shadow-sm border border-base-300">
            <div class="card-body p-4">
                <!-- Search Form -->
                <form id="search-form" method="get" action="{% url 'keywords:project_keywords' project.id %}">
                    <!-- Hidden fields for sorting -->
                    <input type="hidden" name="sort" id="sort-field" value="{{ sort_by }}">
                    <input type="hidden" name="order" id="order-field" value="{{ sort_order }}">
                    
                    <!-- Search Row -->
                    <div class="flex gap-2 mb-3">
                        <div class="relative flex-1">
                            <input 
                                type="text" 
                                id="search-input"
                                name="search"
                                placeholder="Search by Keyword" 
                                class="input input-bordered input-sm w-full pl-10"
                                value="{{ search_query }}"
                                hx-get="{% url 'keywords:project_keywords' project.id %}"
                                hx-trigger="keyup changed delay:500ms, search"
                                hx-target="#keywords-container"
                                hx-include="#search-form"
                            >
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-base-content/40 text-sm"></i>
                        </div>
                        
                        <!-- Search Button -->
                        <button 
                            type="button"
                            class="btn btn-primary btn-sm"
                            hx-get="{% url 'keywords:project_keywords' project.id %}"
                            hx-trigger="click"
                            hx-target="#keywords-container"
                            hx-include="#search-form"
                        >
                            Search
                        </button>
                        
                        <!-- Clear Button -->
                        <button 
                            type="button"
                            class="btn btn-ghost btn-sm"
                            onclick="clearAllFilters()"
                        >
                            Clear
                        </button>
                    </div>
                    
                    <!-- Advanced Filters Row -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-3">
                        <!-- Country Filter -->
                        <select name="country" id="country-filter" class="select select-bordered select-sm"
                                hx-get="{% url 'keywords:project_keywords' project.id %}"
                                hx-trigger="change"
                                hx-target="#keywords-container"
                                hx-include="#search-form">
                            <option value="">All Countries</option>
                            <option value="US" {% if request.GET.country == 'US' %}selected{% endif %}>United States</option>
                            <option value="GB" {% if request.GET.country == 'GB' %}selected{% endif %}>United Kingdom</option>
                            <option value="CA" {% if request.GET.country == 'CA' %}selected{% endif %}>Canada</option>
                            <option value="AU" {% if request.GET.country == 'AU' %}selected{% endif %}>Australia</option>
                            <option value="DE" {% if request.GET.country == 'DE' %}selected{% endif %}>Germany</option>
                            <option value="FR" {% if request.GET.country == 'FR' %}selected{% endif %}>France</option>
                            <option value="IN" {% if request.GET.country == 'IN' %}selected{% endif %}>India</option>
                        </select>
                        
                        <!-- Tags Filter -->
                        <select name="tag" id="tag-filter" class="select select-bordered select-sm"
                                hx-get="{% url 'keywords:project_keywords' project.id %}"
                                hx-trigger="change"
                                hx-target="#keywords-container"
                                hx-include="#search-form">
                            <option value="">All Tags</option>
                            {% for tag in available_tags %}
                            <option value="{{ tag.id }}" {% if request.GET.tag == tag.id|stringformat:"s" %}selected{% endif %}>
                                {{ tag.name }}
                            </option>
                            {% endfor %}
                        </select>
                        
                        <!-- Rank Comparison -->
                        <select name="rank_compare" id="rank-compare" class="select select-bordered select-sm"
                                hx-get="{% url 'keywords:project_keywords' project.id %}"
                                hx-trigger="change"
                                hx-target="#keywords-container"
                                hx-include="#search-form">
                            <option value="">All Ranks</option>
                            <option value="eq" {% if request.GET.rank_compare == 'eq' %}selected{% endif %}>Rank Equal To</option>
                            <option value="lt" {% if request.GET.rank_compare == 'lt' %}selected{% endif %}>Rank Less Than</option>
                            <option value="gt" {% if request.GET.rank_compare == 'gt' %}selected{% endif %}>Rank Greater Than</option>
                            <option value="between" {% if request.GET.rank_compare == 'between' %}selected{% endif %}>Rank Between</option>
                        </select>
                        
                        <!-- Rank Value -->
                        <div class="flex gap-1">
                            <input 
                                type="number" 
                                name="rank_value" 
                                id="rank-value"
                                placeholder="Rank"
                                min="1" 
                                max="100"
                                class="input input-bordered input-sm w-20"
                                value="{{ request.GET.rank_value }}"
                                hx-get="{% url 'keywords:project_keywords' project.id %}"
                                hx-trigger="change delay:500ms"
                                hx-target="#keywords-container"
                                hx-include="#search-form"
                            >
                            <input 
                                type="number" 
                                name="rank_value2" 
                                id="rank-value2"
                                placeholder="To"
                                min="1" 
                                max="100"
                                class="input input-bordered input-sm w-20 {% if request.GET.rank_compare != 'between' %}hidden{% endif %}"
                                value="{{ request.GET.rank_value2 }}"
                                hx-get="{% url 'keywords:project_keywords' project.id %}"
                                hx-trigger="change delay:500ms"
                                hx-target="#keywords-container"
                                hx-include="#search-form"
                            >
                        </div>
                    </div>
                </form>
                
                <!-- Filter Buttons -->
                <div class="flex items-center gap-2 flex-wrap">
                    <span class="text-sm text-base-content/60 mr-2">Filter:</span>
                    
                    <button 
                        type="button"
                        class="btn btn-sm {% if filter_status == 'all' or not filter_status %}btn-primary{% else %}btn-outline{% endif %}"
                        data-filter="all"
                        onclick="applyFilter('all')"
                    >
                        All
                        <span class="badge badge-sm ml-1">{{ total_keywords }}</span>
                    </button>
                    
                    <button 
                        type="button"
                        class="btn btn-sm {% if filter_status == 'top10' %}btn-success{% else %}btn-outline btn-success{% endif %}"
                        data-filter="top10"
                        onclick="applyFilter('top10')"
                    >
                        <i class="fas fa-trophy mr-1"></i>
                        Top 10
                        <span class="badge badge-sm ml-1">{{ top10_count }}</span>
                    </button>
                    
                    <button 
                        type="button"
                        class="btn btn-sm {% if filter_status == 'improved' %}btn-info{% else %}btn-outline btn-info{% endif %}"
                        data-filter="improved"
                        onclick="applyFilter('improved')"
                    >
                        <i class="fas fa-arrow-up mr-1"></i>
                        Improved
                        <span class="badge badge-sm ml-1">{{ improved_count }}</span>
                    </button>
                    
                    <button 
                        type="button"
                        class="btn btn-sm {% if filter_status == 'declined' %}btn-warning{% else %}btn-outline btn-warning{% endif %}"
                        data-filter="declined"
                        onclick="applyFilter('declined')"
                    >
                        <i class="fas fa-arrow-down mr-1"></i>
                        Declined
                        <span class="badge badge-sm ml-1">{{ declined_count }}</span>
                    </button>
                    
                    <button 
                        type="button"
                        class="btn btn-sm {% if filter_status == 'not_ranking' %}btn-error{% else %}btn-outline btn-error{% endif %}"
                        data-filter="not_ranking"
                        onclick="applyFilter('not_ranking')"
                    >
                        <i class="fas fa-times-circle mr-1"></i>
                        Not Ranking
                        <span class="badge badge-sm ml-1">{{ not_ranking_count }}</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Statistics Cards -->
    <div class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-8">
        <div class="card bg-base-100 shadow-sm border border-base-300">
            <div class="card-body p-4">
                <p class="text-base-content/60 text-xs">Total</p>
                <p class="text-2xl font-bold text-base-content">{{ total_keywords }}</p>
            </div>
        </div>
        
        <div class="card bg-base-100 shadow-sm border border-base-300">
            <div class="card-body p-4">
                <p class="text-base-content/60 text-xs">Avg Rank</p>
                <p class="text-2xl font-bold text-base-content">{{ avg_rank|floatformat:1 }}</p>
            </div>
        </div>
        
        <div class="card bg-base-100 shadow-sm border border-base-300">
            <div class="card-body p-4">
                <p class="text-base-content/60 text-xs">Top 10</p>
                <p class="text-2xl font-bold text-success">{{ top10_count }}</p>
            </div>
        </div>
        
        <div class="card bg-base-100 shadow-sm border border-base-300">
            <div class="card-body p-4">
                <p class="text-base-content/60 text-xs">Improved</p>
                <p class="text-2xl font-bold text-info">{{ improved_count }}</p>
            </div>
        </div>
        
        <div class="card bg-base-100 shadow-sm border border-base-300">
            <div class="card-body p-4">
                <p class="text-base-content/60 text-xs">Declined</p>
                <p class="text-2xl font-bold text-warning">{{ declined_count }}</p>
            </div>
        </div>
        
        <div class="card bg-base-100 shadow-sm border border-base-300">
            <div class="card-body p-4">
                <p class="text-base-content/60 text-xs">Not Ranking</p>
                <p class="text-2xl font-bold text-error">{{ not_ranking_count }}</p>
            </div>
        </div>
    </div>
    
    <!-- Bulk Actions Bar (hidden by default) -->
    <div id="bulk-actions-bar" class="hidden mb-4 sticky top-0 z-10">
        <div class="card bg-primary text-primary-content shadow-lg">
            <div class="card-body p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <span class="font-semibold">
                            <span id="selected-count">0</span> keywords selected
                        </span>
                        <button onclick="clearSelection()" class="btn btn-ghost btn-sm">
                            Clear Selection
                        </button>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="bulkRecheckRank()" class="btn btn-sm btn-secondary">
                            <i class="fas fa-sync mr-2"></i>
                            Recheck Rank
                        </button>
                        <button onclick="openBulkDeleteModal()" class="btn btn-sm btn-error">
                            <i class="fas fa-trash mr-2"></i>
                            Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Keywords Container -->
    <div id="keywords-container">
        {% include 'keywords/partials/keywords_table_with_pagination.html' %}
    </div>

<!-- Modal Container -->
<div id="modal-container"></div>

<!-- Delete Keyword Modal -->
<dialog id="delete-keyword-modal" class="modal">
    <div class="modal-box max-w-md">
        <!-- Modal Header with Icon -->
        <div class="flex items-center gap-4 mb-4">
            <div class="w-12 h-12 rounded-full bg-error/20 flex items-center justify-center">
                <i class="fas fa-trash-alt text-error text-xl"></i>
            </div>
            <div>
                <h3 class="font-bold text-lg">Delete Keyword</h3>
                <p class="text-sm text-base-content/60">This action cannot be undone</p>
            </div>
        </div>
        
        <!-- Modal Content -->
        <div class="py-4">
            <div class="alert alert-error mb-4">
                <i class="fas fa-exclamation-circle"></i>
                <span>Warning: This will permanently delete all ranking data and history for this keyword.</span>
            </div>
            
            <div class="mb-4">
                <p class="text-base-content mb-2">You are about to delete the keyword:</p>
                <p class="font-bold text-lg px-4 py-2 bg-base-200 rounded-lg" id="delete-keyword-text"></p>
            </div>
            
            <div class="divider"></div>
            
            <div class="space-y-3 mb-4">
                <p class="text-sm text-base-content/80">This action will delete:</p>
                <ul class="space-y-2 text-sm">
                    <li class="flex items-center gap-2">
                        <i class="fas fa-times-circle text-error"></i>
                        <span>All historical ranking data</span>
                    </li>
                    <li class="flex items-center gap-2">
                        <i class="fas fa-times-circle text-error"></i>
                        <span>SERP snapshots and cached data</span>
                    </li>
                    <li class="flex items-center gap-2">
                        <i class="fas fa-times-circle text-error"></i>
                        <span>Competitor tracking for this keyword</span>
                    </li>
                    <li class="flex items-center gap-2">
                        <i class="fas fa-times-circle text-error"></i>
                        <span>Associated reports and analytics</span>
                    </li>
                </ul>
            </div>
            
            <div class="form-control">
                <label class="label">
                    <span class="label-text font-semibold">Type <span class="text-error">"confirm"</span> to delete this keyword:</span>
                </label>
                <input 
                    type="text" 
                    id="delete-confirmation-input"
                    class="input input-bordered" 
                    placeholder="Type 'confirm' here"
                    oninput="validateKeywordDeleteConfirmation()"
                    autocomplete="off"
                />
                <label class="label">
                    <span class="label-text-alt text-error" id="delete-input-error"></span>
                </label>
            </div>
        </div>
        
        <!-- Modal Actions -->
        <div class="modal-action">
            <form method="dialog">
                <button class="btn btn-ghost">Cancel</button>
            </form>
            <button 
                type="button" 
                id="confirm-delete-btn"
                class="btn btn-error" 
                disabled
                onclick="confirmDeleteKeyword()"
            >
                <i class="fas fa-trash mr-2"></i>
                Delete Keyword
            </button>
        </div>
    </div>
    
    <!-- Click outside to close -->
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Bulk Delete Keywords Modal -->
<dialog id="bulk-delete-keywords-modal" class="modal">
    <div class="modal-box max-w-md">
        <!-- Modal Header with Icon -->
        <div class="flex items-center gap-4 mb-4">
            <div class="w-12 h-12 rounded-full bg-error/20 flex items-center justify-center">
                <i class="fas fa-trash-alt text-error text-xl"></i>
            </div>
            <div>
                <h3 class="font-bold text-lg">Delete Keywords</h3>
                <p class="text-sm text-base-content/60">This action cannot be undone</p>
            </div>
        </div>
        
        <!-- Modal Content -->
        <div class="py-4">
            <div class="alert alert-error mb-4">
                <i class="fas fa-exclamation-circle"></i>
                <span>Warning: This will permanently delete <span id="bulk-delete-count" class="font-bold">0</span> selected keywords and all their ranking data.</span>
            </div>
            
            <div class="divider"></div>
            
            <div class="space-y-3 mb-4">
                <p class="text-sm text-base-content/80">This action will delete:</p>
                <ul class="space-y-2 text-sm">
                    <li class="flex items-center gap-2">
                        <i class="fas fa-times-circle text-error"></i>
                        <span>All ranking history for selected keywords</span>
                    </li>
                    <li class="flex items-center gap-2">
                        <i class="fas fa-times-circle text-error"></i>
                        <span>All competitor data for selected keywords</span>
                    </li>
                    <li class="flex items-center gap-2">
                        <i class="fas fa-times-circle text-error"></i>
                        <span>All reports containing selected keywords</span>
                    </li>
                </ul>
            </div>
            
            <div class="form-control">
                <label class="label">
                    <span class="label-text font-semibold">Type <span class="text-error">"confirm"</span> to delete these keywords:</span>
                </label>
                <input 
                    type="text" 
                    id="bulk-delete-confirmation-input"
                    class="input input-bordered" 
                    placeholder="Type 'confirm' here"
                    oninput="validateBulkDeleteConfirmation()"
                    autocomplete="off"
                />
                <label class="label">
                    <span class="label-text-alt text-error" id="bulk-delete-input-error"></span>
                </label>
            </div>
        </div>
        
        <!-- Modal Actions -->
        <div class="modal-action">
            <form method="dialog">
                <button class="btn btn-ghost" onclick="closeBulkDeleteModal()">Cancel</button>
            </form>
            <button 
                id="confirm-bulk-delete-btn"
                class="btn btn-error" 
                disabled
                onclick="confirmBulkDelete()"
            >
                <i class="fas fa-trash mr-2"></i>
                Delete Keywords
            </button>
        </div>
    </div>
    
    <!-- Click outside to close -->
    <form method="dialog" class="modal-backdrop">
        <button onclick="closeBulkDeleteModal()">close</button>
    </form>
</dialog>

<script>
    // Sort table by column
    function sortTable(column) {
        const form = document.getElementById('search-form');
        const formData = new FormData(form);
        const params = new URLSearchParams(formData);
        
        // Get current sort parameters from hidden fields
        const currentSort = document.getElementById('sort-field').value || 'keyword';
        const currentOrder = document.getElementById('order-field').value || 'asc';
        
        // Determine new sort order
        let newOrder = 'asc';
        if (column === currentSort) {
            // If clicking the same column, toggle order
            newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
        }
        
        // Add sort parameters
        params.set('sort', column);
        params.set('order', newOrder);
        params.set('page', 1); // Reset to first page when sorting
        
        // Preserve filter if active
        const activeFilter = document.querySelector('.btn-primary[data-filter]');
        if (activeFilter) {
            params.set('filter', activeFilter.dataset.filter);
        }
        
        // Make HTMX request
        // Make the HTMX request
        const url = '{% url "keywords:project_keywords" project.id %}?' + params.toString();
        htmx.ajax('GET', url, {
            target: '#keywords-container',
            swap: 'innerHTML'
        });
    }
    
    // Update sort indicators in the header
    function updateSortIndicators(sortBy, sortOrder) {
        // Reset all indicators
        document.querySelectorAll('.sort-indicator').forEach(indicator => {
            indicator.innerHTML = '<i class="fas fa-sort text-base-content/30"></i>';
        });
        
        // Update the active column's indicator
        const activeButton = document.querySelector(`button[data-sort="${sortBy}"]`);
        if (activeButton) {
            const indicator = activeButton.querySelector('.sort-indicator');
            if (indicator) {
                if (sortOrder === 'asc') {
                    indicator.innerHTML = '<i class="fas fa-sort-up text-primary"></i>';
                } else {
                    indicator.innerHTML = '<i class="fas fa-sort-down text-primary"></i>';
                }
            }
        }
    }
    
    // Apply filter
    function applyFilter(filterValue) {
        const form = document.getElementById('search-form');
        const formData = new FormData(form);
        const params = new URLSearchParams(formData);
        params.set('filter', filterValue);
        params.set('page', 1); // Reset to first page
        
        // Get current sort from hidden inputs
        const sortInput = document.querySelector('input[name="sort"]');
        const orderInput = document.querySelector('input[name="order"]');
        params.set('sort', sortInput ? sortInput.value : 'keyword');
        params.set('order', orderInput ? orderInput.value : 'asc');
        
        // Make the HTMX request
        const url = '{% url "keywords:project_keywords" project.id %}?' + params.toString();
        htmx.ajax('GET', url, {
            target: '#keywords-container',
            swap: 'innerHTML'
        });
    }
    
    // Perform search with all filters
    function performSearch() {
        const form = document.getElementById('search-form');
        const formData = new FormData(form);
        const params = new URLSearchParams(formData);
        
        // Add filter parameter if active
        const activeFilter = document.querySelector('.btn-primary[data-filter]');
        if (activeFilter) {
            params.append('filter', activeFilter.dataset.filter);
        }
        
        // Get current sort from hidden inputs
        const sortInput = document.querySelector('input[name="sort"]');
        const orderInput = document.querySelector('input[name="order"]');
        params.set('sort', sortInput ? sortInput.value : 'keyword');
        params.set('order', orderInput ? orderInput.value : 'asc');
        params.set('page', 1); // Reset to first page on new search
        
        // Make the HTMX request
        const url = '{% url "keywords:project_keywords" project.id %}?' + params.toString();
        htmx.ajax('GET', url, {
            target: '#keywords-container',
            swap: 'innerHTML'
        });
    }
    
    // Clear all filters
    function clearAllFilters() {
        document.getElementById('search-input').value = '';
        document.getElementById('country-filter').value = '';
        document.getElementById('tag-filter').value = '';
        document.getElementById('rank-compare').value = '';
        document.getElementById('rank-value').value = '';
        document.getElementById('rank-value2').value = '';
        
        htmx.ajax('GET', '{% url "keywords:project_keywords" project.id %}', {
            target: '#keywords-container',
            swap: 'innerHTML'
        });
    }
    
    // Go to specific page
    function goToPage(page) {
        const form = document.getElementById('search-form');
        const formData = new FormData(form);
        const params = new URLSearchParams(formData);
        params.append('page', page);
        
        // Add filter parameter
        const activeFilter = document.querySelector('.btn-primary[data-filter]');
        if (activeFilter) {
            params.append('filter', activeFilter.dataset.filter);
        }
        
        // Make the HTMX request
        const url = '{% url "keywords:project_keywords" project.id %}?' + params.toString();
        htmx.ajax('GET', url, {
            target: '#keywords-container',
            swap: 'innerHTML'
        });
    }
    
    // Change per page
    function changePerPage(value) {
        const form = document.getElementById('search-form');
        const formData = new FormData(form);
        const params = new URLSearchParams(formData);
        params.set('per_page', value);
        params.set('page', 1); // Reset to first page
        
        // When changing per page, we need to reload the entire page to update pagination controls
        window.location.href = '{% url "keywords:project_keywords" project.id %}?' + params.toString();
    }
    
    // Handle rank comparison change
    document.getElementById('rank-compare').addEventListener('change', function() {
        const rankValue2 = document.getElementById('rank-value2');
        if (this.value === 'between') {
            rankValue2.classList.remove('hidden');
        } else {
            rankValue2.classList.add('hidden');
        }
    });
    
    // Handle enter key in search input
    document.getElementById('search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            performSearch();
        }
    });
    
    // Listen for successful keyword additions
    document.body.addEventListener('keywordsAdded', function(evt) {
        // Properly reload the keywords table without disturbing layout
        window.location.reload();
    });
    
    // Listen for HTMX after swap events to update sort state
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.target.id === 'keywords-table-body') {
            // Look for the hidden sort info element
            const sortInfo = document.querySelector('[data-sort-info="true"]');
            if (sortInfo) {
                // Update hidden fields with new sort state
                document.getElementById('sort-field').value = sortInfo.dataset.sortBy;
                document.getElementById('order-field').value = sortInfo.dataset.sortOrder;
                
                // Update sort indicators
                updateSortIndicators(sortInfo.dataset.sortBy, sortInfo.dataset.sortOrder);
            }
        }
    });
    
    // Handle Re-Check Rank response
    function handleRecheckResponse(event) {
        const response = event.detail.xhr.response;
        try {
            const data = JSON.parse(response);
            if (data.success) {
                // Show success message
                showNotification('Rank re-check initiated successfully', 'success');
                // Update the keyword row to show processing state
                const row = event.target.closest('tr');
                if (row) {
                    const rankCell = row.querySelector('.rank-cell');
                    if (rankCell) {
                        rankCell.innerHTML = '<span class="badge badge-ghost gap-1"><span class="loading loading-spinner loading-xs"></span>Checking</span>';
                    }
                }
            } else {
                // Show error message
                showNotification(data.message || 'Unable to re-check rank. Please try again later.', 'error');
            }
        } catch (e) {
            showNotification('An error occurred. Please try again.', 'error');
        }
    }
    
    // Show notification
    function showNotification(message, type = 'info') {
        // Create toast notification
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'error' : 'info'} fixed top-4 right-4 z-50 max-w-sm shadow-lg`;
        toast.innerHTML = `
            <div>
                <span>${message}</span>
            </div>
        `;
        document.body.appendChild(toast);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            toast.remove();
        }, 5000);
    }
    
    // Delete keyword functionality
    let deleteKeywordId = null;
    let deleteKeywordText = null;
    
    // Get CSRF token
    function getCookie(name) {
        const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
        return m ? m.pop() : '';
    }
    
    // Open delete modal
    function deleteKeyword(keywordId, keywordText) {
        deleteKeywordId = keywordId;
        deleteKeywordText = keywordText;
        
        // Reset modal state
        const modal = document.getElementById('delete-keyword-modal');
        const keywordDisplay = document.getElementById('delete-keyword-text');
        const confirmInput = document.getElementById('delete-confirmation-input');
        const confirmBtn = document.getElementById('confirm-delete-btn');
        const errorLabel = document.getElementById('delete-input-error');
        
        keywordDisplay.textContent = keywordText;
        confirmInput.value = '';
        confirmBtn.disabled = true;
        errorLabel.textContent = '';
        confirmInput.classList.remove('input-error');
        
        // Show modal using dialog API
        modal.showModal();
        confirmInput.focus();
    }
    
    // Validate keyword deletion confirmation
    function validateKeywordDeleteConfirmation() {
        const input = document.getElementById('delete-confirmation-input');
        const confirmBtn = document.getElementById('confirm-delete-btn');
        const errorLabel = document.getElementById('delete-input-error');
        
        if (input.value.toLowerCase() === 'confirm') {
            confirmBtn.disabled = false;
            errorLabel.textContent = '';
            input.classList.remove('input-error');
        } else {
            confirmBtn.disabled = true;
            if (input.value.length > 0) {
                errorLabel.textContent = 'Please type "confirm" to delete';
                input.classList.add('input-error');
            } else {
                errorLabel.textContent = '';
                input.classList.remove('input-error');
            }
        }
    }
    
    // Initialize delete confirmation input validation after DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        const deleteInput = document.getElementById('delete-confirmation-input');
        if (deleteInput) {
            // Handle Enter key in delete confirmation input
            deleteInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && e.target.value.toLowerCase() === 'confirm') {
                    confirmDeleteKeyword();
                }
            });
        }
    });
    
    // Confirm and execute deletion
    async function confirmDeleteKeyword() {
        if (!deleteKeywordId || !deleteKeywordText) return;
        
        const confirmBtn = document.getElementById('confirm-delete-btn');
        const originalText = confirmBtn.innerHTML;
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Deleting...';
        confirmBtn.disabled = true;
        
        try {
            const response = await fetch(`/keywords/api/keyword/${deleteKeywordId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Close modal
                const modal = document.getElementById('delete-keyword-modal');
                modal.close();
                
                // Show success message
                showNotification(`Keyword "${deleteKeywordText}" has been deleted successfully.`, 'success');
                
                // Animate and remove keyword row
                const keywordRow = document.querySelector(`tr[data-keyword-id="${deleteKeywordId}"]`);
                if (keywordRow) {
                    keywordRow.style.transition = 'opacity 0.3s, transform 0.3s';
                    keywordRow.style.opacity = '0';
                    keywordRow.style.transform = 'translateX(-20px)';
                    
                    setTimeout(() => {
                        keywordRow.remove();
                        
                        // Update statistics
                        updateKeywordStatistics();
                        
                        // Check if any keywords remain
                        const remainingRows = document.querySelectorAll('#keywords-table tbody tr');
                        if (remainingRows.length === 0) {
                            // Show empty state
                            showEmptyState();
                        }
                    }, 300);
                } else {
                    // If row not found, reload the page as fallback
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                }
            } else {
                // Show error message
                const errorLabel = document.getElementById('delete-input-error');
                errorLabel.textContent = data.message || 'Failed to delete keyword. Please try again.';
                confirmBtn.innerHTML = originalText;
                confirmBtn.disabled = false;
            }
        } catch (error) {
            console.error('Error:', error);
            const errorLabel = document.getElementById('delete-input-error');
            errorLabel.textContent = 'An error occurred. Please try again.';
            confirmBtn.innerHTML = originalText;
            confirmBtn.disabled = false;
        }
    }
    
    // Update keyword statistics after deletion
    function updateKeywordStatistics() {
        // Decrement total count
        const totalElement = document.querySelector('.card-body p.text-2xl.font-bold.text-base-content');
        if (totalElement) {
            const currentTotal = parseInt(totalElement.textContent);
            if (!isNaN(currentTotal) && currentTotal > 0) {
                totalElement.textContent = currentTotal - 1;
            }
        }
        
        // Update filter button counts
        const allButton = document.querySelector('button[data-filter="all"] .badge');
        if (allButton) {
            const currentCount = parseInt(allButton.textContent);
            if (!isNaN(currentCount) && currentCount > 0) {
                allButton.textContent = currentCount - 1;
            }
        }
        
        // Update pagination info
        const paginationInfo = document.querySelector('.text-sm.text-base-content\\/60');
        if (paginationInfo && paginationInfo.textContent.includes('of')) {
            const match = paginationInfo.textContent.match(/of (\d+) results/);
            if (match) {
                const totalResults = parseInt(match[1]);
                if (!isNaN(totalResults) && totalResults > 0) {
                    paginationInfo.textContent = paginationInfo.textContent.replace(
                        `of ${totalResults} results`,
                        `of ${totalResults - 1} results`
                    );
                }
            }
        }
    }
    
    // Show empty state when no keywords remain
    function showEmptyState() {
        const tableContainer = document.getElementById('keywords-table');
        if (tableContainer) {
            tableContainer.innerHTML = `
                <div class="p-12 text-center">
                    <div class="w-20 h-20 bg-base-200 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-key text-2xl text-base-content/40"></i>
                    </div>
                    <h3 class="text-lg font-semibold mb-2">No Keywords Yet</h3>
                    <p class="text-base-content/60 mb-6">Add keywords to start tracking rankings for this project.</p>
                    <button 
                        hx-get="{% url 'keywords:add_keyword_modal' %}?project_id={{ project.id }}"
                        hx-trigger="click"
                        hx-target="#modal-container"
                        hx-swap="innerHTML"
                        class="btn btn-primary"
                    >
                        <i class="fas fa-plus mr-2"></i>
                        Add Your First Keywords
                    </button>
                </div>
            `;
            
            // Remove pagination card
            const paginationCard = document.querySelector('.card.bg-base-100.shadow-sm.border.border-base-300.mt-4');
            if (paginationCard) {
                paginationCard.remove();
            }
        }
    }
    
    // SSE for real-time updates
    let eventSource = null;
    
    function connectSSE() {
        if (eventSource) {
            eventSource.close();
        }
        
        eventSource = new EventSource('{% url "keywords:keyword_updates_sse" project.id %}');
        
        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);
            const row = document.querySelector(`tr[data-keyword-id="${data.id}"]`);
            
            if (row) {
                // Update keyword row with new data
                const rankCell = row.querySelector('.rank-cell');
                const changeCell = row.querySelector('.change-cell');
                const keywordCell = row.querySelectorAll('td')[1]; // Second td (after checkbox)
                const lastCheckedCell = row.querySelectorAll('td')[5]; // 6th td (last checked column)
                
                if (data.processing) {
                    // Show processing status
                    rankCell.innerHTML = `
                        <span class="badge badge-ghost gap-1">
                            <span class="loading loading-spinner loading-xs"></span>
                            Checking
                        </span>
                    `;
                    changeCell.innerHTML = '<span class="text-base-content/40">-</span>';
                    
                    // Add spinner to keyword name if not already present
                    const keywordDiv = keywordCell.querySelector('div:first-child');
                    if (keywordDiv && !keywordDiv.querySelector('.loading')) {
                        const spinner = document.createElement('span');
                        spinner.className = 'loading loading-spinner loading-xs text-primary';
                        spinner.title = 'Checking rank...';
                        keywordDiv.appendChild(spinner);
                    }
                } else {
                    // Remove processing spinner from keyword name
                    const spinner = keywordCell.querySelector('.loading');
                    if (spinner) {
                        spinner.remove();
                    }
                    
                    // Update rank
                    if (data.rank > 0 && data.rank <= 100) {
                        let rankClass = 'rank-top100';
                        if (data.rank === 1) rankClass = 'rank-1';
                        else if (data.rank === 2) rankClass = 'rank-2';
                        else if (data.rank === 3) rankClass = 'rank-3';
                        else if (data.rank <= 10) rankClass = 'rank-top10';
                        else if (data.rank <= 30) rankClass = 'rank-top30';
                        else if (data.rank <= 50) rankClass = 'rank-top50';
                        
                        rankCell.innerHTML = `<span class="badge rank-badge ${rankClass}">#${data.rank}</span>`;
                    } else {
                        rankCell.innerHTML = '<span class="badge rank-badge rank-none">NR</span>';
                    }
                    
                    // Update change
                    if (data.rank_diff && data.rank_diff !== 0) {
                        if (data.rank_diff > 0) {
                            changeCell.innerHTML = `
                                <span class="flex items-center justify-center gap-1">
                                    <i class="fas fa-arrow-up text-xs rank-change-up"></i>
                                    <span class="text-sm font-semibold rank-change-up">+${data.rank_diff}</span>
                                </span>
                            `;
                        } else {
                            changeCell.innerHTML = `
                                <span class="flex items-center justify-center gap-1">
                                    <i class="fas fa-arrow-down text-xs rank-change-down"></i>
                                    <span class="text-sm font-semibold rank-change-down">${data.rank_diff}</span>
                                </span>
                            `;
                        }
                    } else {
                        changeCell.innerHTML = '<span class="text-base-content/40">-</span>';
                    }
                    
                    // Update URL if present
                    if (data.rank_url) {
                        const existingUrlDiv = keywordCell.querySelector('div:nth-child(2)');
                        if (existingUrlDiv && existingUrlDiv.querySelector('a')) {
                            const link = existingUrlDiv.querySelector('a');
                            link.href = data.rank_url;
                            link.title = data.rank_url;
                            link.innerHTML = `<i class="fas fa-link text-[10px] mr-1"></i>${data.rank_url.substring(0, 50)}${data.rank_url.length > 50 ? '...' : ''}`;
                        } else if (!existingUrlDiv) {
                            // Add URL div if it doesn't exist
                            const keywordDiv = keywordCell.querySelector('div:first-child');
                            const urlDiv = document.createElement('div');
                            urlDiv.className = 'mt-1';
                            urlDiv.innerHTML = `
                                <a href="${data.rank_url}" target="_blank" class="text-xs text-base-content/60 hover:text-primary hover:underline block truncate max-w-xs" title="${data.rank_url}">
                                    <i class="fas fa-link text-[10px] mr-1"></i>${data.rank_url.substring(0, 50)}${data.rank_url.length > 50 ? '...' : ''}
                                </a>
                            `;
                            keywordDiv.after(urlDiv);
                        }
                    }
                    
                    // Update last checked time
                    if (lastCheckedCell) {
                        if (data.scraped_at) {
                            // Update with "just now" since it was just checked
                            lastCheckedCell.innerHTML = '<span class="text-sm">just now</span>';
                        } else {
                            lastCheckedCell.innerHTML = '<span class="text-sm text-base-content/40">Never</span>';
                        }
                    }
                    
                    // Add animation effect
                    row.classList.add('animate-pulse');
                    setTimeout(() => row.classList.remove('animate-pulse'), 1000);
                }
            }
        };
        
        eventSource.onerror = function(error) {
            console.error('SSE error:', error);
            // Reconnect after 5 seconds
            setTimeout(connectSSE, 5000);
        };
    }
    
    // Connect to SSE on page load
    connectSSE();
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (eventSource) {
            eventSource.close();
        }
    });
    
    // Bulk Actions Functions
    let selectedKeywords = new Set();
    
    // Toggle all keywords selection
    function toggleAllKeywords(checkbox) {
        const checkboxes = document.querySelectorAll('.keyword-checkbox');
        selectedKeywords.clear();
        
        checkboxes.forEach(cb => {
            cb.checked = checkbox.checked;
            if (checkbox.checked) {
                selectedKeywords.add(cb.value);
            }
        });
        
        updateBulkActions();
    }
    
    // Update bulk actions bar visibility and count
    function updateBulkActions() {
        const checkboxes = document.querySelectorAll('.keyword-checkbox:checked');
        selectedKeywords.clear();
        
        checkboxes.forEach(cb => {
            selectedKeywords.add(cb.value);
        });
        
        const bulkActionsBar = document.getElementById('bulk-actions-bar');
        const selectedCount = document.getElementById('selected-count');
        const selectAll = document.getElementById('select-all-keywords');
        
        if (selectedKeywords.size > 0) {
            bulkActionsBar.classList.remove('hidden');
            selectedCount.textContent = selectedKeywords.size;
            
            // Update select all checkbox state
            const totalCheckboxes = document.querySelectorAll('.keyword-checkbox').length;
            selectAll.checked = selectedKeywords.size === totalCheckboxes;
            selectAll.indeterminate = selectedKeywords.size > 0 && selectedKeywords.size < totalCheckboxes;
        } else {
            bulkActionsBar.classList.add('hidden');
            selectAll.checked = false;
            selectAll.indeterminate = false;
        }
    }
    
    // Clear selection
    function clearSelection() {
        selectedKeywords.clear();
        document.querySelectorAll('.keyword-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('select-all-keywords').checked = false;
        updateBulkActions();
    }
    
    // Bulk recheck rank
    async function bulkRecheckRank() {
        if (selectedKeywords.size === 0) return;
        
        const button = event.target.closest('button');
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
        button.disabled = true;
        
        try {
            // Send requests for each selected keyword
            const promises = Array.from(selectedKeywords).map(keywordId => 
                fetch(`/keywords/api/keyword/${keywordId}/force-crawl/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json'
                    }
                })
            );
            
            const results = await Promise.all(promises);
            
            // Count successes
            let successCount = 0;
            for (const result of results) {
                if (result.ok) successCount++;
            }
            
            // Show success message
            showToast(`${successCount} keywords queued for rank checking`, 'success');
            
            // Clear selection
            clearSelection();
            
            // Reload after a short delay to show updated processing status
            setTimeout(() => {
                location.reload();
            }, 1500);
            
        } catch (error) {
            console.error('Error rechecking ranks:', error);
            showToast('Failed to recheck ranks. Please try again.', 'error');
        } finally {
            button.innerHTML = originalHTML;
            button.disabled = false;
        }
    }
    
    // Open bulk delete modal
    function openBulkDeleteModal() {
        if (selectedKeywords.size === 0) return;
        
        const modal = document.getElementById('bulk-delete-keywords-modal');
        const countSpan = document.getElementById('bulk-delete-count');
        const confirmInput = document.getElementById('bulk-delete-confirmation-input');
        const confirmBtn = document.getElementById('confirm-bulk-delete-btn');
        const errorLabel = document.getElementById('bulk-delete-input-error');
        
        // Reset modal state
        countSpan.textContent = selectedKeywords.size;
        confirmInput.value = '';
        confirmBtn.disabled = true;
        errorLabel.textContent = '';
        
        // Show modal
        modal.showModal();
    }
    
    // Close bulk delete modal
    function closeBulkDeleteModal() {
        const modal = document.getElementById('bulk-delete-keywords-modal');
        modal.close();
    }
    
    // Validate bulk delete confirmation
    function validateBulkDeleteConfirmation() {
        const input = document.getElementById('bulk-delete-confirmation-input');
        const confirmBtn = document.getElementById('confirm-bulk-delete-btn');
        const errorLabel = document.getElementById('bulk-delete-input-error');
        
        if (input.value.toLowerCase() === 'confirm') {
            confirmBtn.disabled = false;
            errorLabel.textContent = '';
            input.classList.remove('input-error');
        } else {
            confirmBtn.disabled = true;
            if (input.value.length > 0) {
                errorLabel.textContent = 'Please type "confirm" to delete';
                input.classList.add('input-error');
            } else {
                errorLabel.textContent = '';
                input.classList.remove('input-error');
            }
        }
    }
    
    // Confirm bulk delete
    async function confirmBulkDelete() {
        if (selectedKeywords.size === 0) return;
        
        const confirmBtn = document.getElementById('confirm-bulk-delete-btn');
        const modal = document.getElementById('bulk-delete-keywords-modal');
        
        // Update button to show loading
        const originalHTML = confirmBtn.innerHTML;
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Deleting...';
        confirmBtn.disabled = true;
        
        try {
            // Send delete requests for each selected keyword
            const promises = Array.from(selectedKeywords).map(keywordId => 
                fetch(`/keywords/api/keyword/${keywordId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json'
                    }
                })
            );
            
            const results = await Promise.all(promises);
            
            // Count successes
            let successCount = 0;
            for (const result of results) {
                if (result.ok) successCount++;
            }
            
            // Close modal
            modal.close();
            
            // Show success message
            showToast(`${successCount} keywords deleted successfully`, 'success');
            
            // Clear selection
            clearSelection();
            
            // Reload page after short delay
            setTimeout(() => {
                location.reload();
            }, 1500);
            
        } catch (error) {
            console.error('Error deleting keywords:', error);
            
            // Show error message
            const errorLabel = document.getElementById('bulk-delete-input-error');
            errorLabel.textContent = 'Failed to delete keywords. Please try again.';
            
            // Restore button
            confirmBtn.innerHTML = originalHTML;
            confirmBtn.disabled = false;
        }
    }
    
    // Helper function to show toast messages
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = 'toast toast-top toast-end';
        
        const alertClass = type === 'success' ? 'alert-success' : 
                          type === 'error' ? 'alert-error' : 'alert-info';
        
        const icon = type === 'success' ? 'fa-check-circle' : 
                    type === 'error' ? 'fa-times-circle' : 'fa-info-circle';
        
        toast.innerHTML = `
            <div class="alert ${alertClass}">
                <i class="fas ${icon}"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Remove toast after 5 seconds
        setTimeout(() => {
            toast.remove();
        }, 5000);
    }
    
</script>
{% endblock %}