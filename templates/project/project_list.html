{% extends "dashboard_base.html" %}
{% load static %}

{% block title %}Projects - LimeClicks{% endblock %}
{% block page_title %}Projects{% endblock %}

{% block extra_head %}
<style>
    .project-card {
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .project-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .loading-spinner {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    .health-bar {
        transition: width 1s ease-out;
    }
    
    .pulse-dot {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
        }
    }
    
    .stat-card {
        background: linear-gradient(135deg, var(--fallback-b1, oklch(var(--b1))) 0%, var(--fallback-b2, oklch(var(--b2))) 100%);
    }
    
    .domain-text {
        font-weight: 600;
        color: var(--fallback-bc, oklch(var(--bc)));
    }
    
    .metric-value {
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.2;
    }
    
    .metric-label {
        font-size: 0.75rem;
        opacity: 0.7;
        margin-top: 0.25rem;
    }
    
    .score-circle {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.125rem;
        color: white;
        position: relative;
    }
    
    .score-excellent {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    }
    
    .score-good {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }
    
    .score-average {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }
    
    .score-poor {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    
    .score-none {
        background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
    }
    
    .metric-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
    }
    
    @media (max-width: 768px) {
        .metric-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    .status-badge {
        padding: 0.125rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
    }
    
    @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header Section -->
    <div class="mb-8">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-3xl font-bold text-base-content">Projects</h1>
                <p class="text-base-content/60 mt-1">Manage your domain projects ({{ total_projects }} total)</p>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="openCreateProjectModal()" class="btn btn-primary">
                    <i class="fas fa-plus mr-2"></i>
                    Create Project
                </button>
                <button onclick="location.reload()" class="btn btn-circle btn-ghost">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
        
        <!-- Search and Filter Card -->
        <div class="card bg-base-100 shadow-sm border border-base-300">
            <div class="card-body p-4">
                <!-- Search Bar -->
                <div class="relative">
                    <input 
                        type="text" 
                        id="search-input"
                        name="search"
                        placeholder="Search projects by domain or title..." 
                        class="input input-bordered w-full pl-12 pr-4 h-12"
                        value="{{ search_query }}"
                        hx-get="{% url 'project:project_list' %}"
                        hx-trigger="keyup changed delay:500ms"
                        hx-target="#project-cards-container"
                        hx-swap="outerHTML"
                        hx-indicator="#search-spinner"
                    >
                    <div class="absolute left-4 top-1/2 -translate-y-1/2">
                        <i class="fas fa-search text-base-content/40"></i>
                    </div>
                    <div id="search-spinner" class="htmx-indicator absolute right-4 top-1/2 -translate-y-1/2">
                        <i class="fas fa-spinner loading-spinner text-base-content/40"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Projects List -->
    <div id="project-list">
        <div class="grid grid-cols-1 gap-4" id="project-cards-container">
            {% include "project/partials/project_cards_clean.html" %}
        </div>
    </div>
</div>

<!-- Include the unified create project modal -->
{% include "partials/create_project_modal.html" %}

<script>
function openCreateProjectModal() {
    document.getElementById('create-project-modal').classList.add('modal-open');
}

// Initialize HTMX event handlers
document.addEventListener('htmx:afterSwap', function(event) {
    // Reinitialize any necessary components after HTMX swap
});

// Delete project function - now opens modal
function deleteProject(projectId, domain) {
    openDeleteModal(projectId, domain);
}

function getCookie(name) {
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
}

// Delete modal state
let deleteProjectId = null;
let deleteProjectDomain = null;

// Open delete confirmation modal
function openDeleteModal(projectId, domain) {
    deleteProjectId = projectId;
    deleteProjectDomain = domain;
    
    // Reset modal state
    const modal = document.getElementById('delete_project_modal');
    const domainDisplay = document.getElementById('delete-project-domain');
    const confirmInput = document.getElementById('delete-confirmation-input');
    const confirmBtn = document.getElementById('confirm-delete-btn');
    const errorLabel = document.getElementById('delete-input-error');
    
    // Set domain display
    domainDisplay.textContent = domain;
    
    // Reset input and button state
    confirmInput.value = '';
    confirmBtn.disabled = true;
    errorLabel.textContent = '';
    
    // Show modal
    modal.showModal();
}

// Validate confirmation input
function validateDeleteConfirmation() {
    const input = document.getElementById('delete-confirmation-input');
    const confirmBtn = document.getElementById('confirm-delete-btn');
    const errorLabel = document.getElementById('delete-input-error');
    
    if (input.value.toLowerCase() === 'confirm') {
        confirmBtn.disabled = false;
        errorLabel.textContent = '';
        input.classList.remove('input-error');
    } else {
        confirmBtn.disabled = true;
        if (input.value.length > 0) {
            errorLabel.textContent = 'Please type "confirm" to delete';
            input.classList.add('input-error');
        } else {
            errorLabel.textContent = '';
            input.classList.remove('input-error');
        }
    }
}

// Confirm and execute deletion
async function confirmDeleteProject() {
    if (!deleteProjectId || !deleteProjectDomain) return;
    
    const confirmBtn = document.getElementById('confirm-delete-btn');
    const modal = document.getElementById('delete_project_modal');
    
    // Update button to show loading
    const originalHTML = confirmBtn.innerHTML;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Deleting...';
    confirmBtn.disabled = true;
    
    try {
        const response = await fetch(`/projects/${deleteProjectId}/delete/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Close modal
            modal.close();
            
            // Show success message
            const toast = document.createElement('div');
            toast.className = 'toast toast-top toast-end';
            toast.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    <span>Project "${deleteProjectDomain}" has been deleted successfully.</span>
                </div>
            `;
            document.body.appendChild(toast);
            
            // Reload page after short delay
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            // Show error message
            const errorLabel = document.getElementById('delete-input-error');
            errorLabel.textContent = data.message || 'Failed to delete project. Please try again.';
            
            // Restore button
            confirmBtn.innerHTML = originalHTML;
            confirmBtn.disabled = false;
        }
    } catch (error) {
        console.error('Error deleting project:', error);
        
        // Show error message
        const errorLabel = document.getElementById('delete-input-error');
        errorLabel.textContent = 'An error occurred. Please try again.';
        
        // Restore button
        confirmBtn.innerHTML = originalHTML;
        confirmBtn.disabled = false;
    }
}
</script>

<!-- Delete Project Confirmation Modal -->
<dialog id="delete_project_modal" class="modal">
    <div class="modal-box max-w-md">
        <!-- Modal Header with Icon -->
        <div class="flex items-center gap-4 mb-4">
            <div class="w-12 h-12 rounded-full bg-error/20 flex items-center justify-center">
                <i class="fas fa-trash-alt text-error text-xl"></i>
            </div>
            <div>
                <h3 class="font-bold text-lg">Delete Project</h3>
                <p class="text-sm text-base-content/60">This action cannot be undone</p>
            </div>
        </div>
        
        <!-- Modal Content -->
        <div class="py-4">
            <div class="alert alert-error mb-4">
                <i class="fas fa-exclamation-circle"></i>
                <span>Warning: This will permanently delete all project data including keywords, audits, and reports.</span>
            </div>
            
            <div class="mb-4">
                <p class="text-base-content mb-2">You are about to delete the project:</p>
                <p class="font-bold text-lg px-4 py-2 bg-base-200 rounded-lg" id="delete-project-domain"></p>
            </div>
            
            <div class="divider"></div>
            
            <div class="space-y-3 mb-4">
                <p class="text-sm text-base-content/80">This action will delete:</p>
                <ul class="space-y-2 text-sm">
                    <li class="flex items-center gap-2">
                        <i class="fas fa-times-circle text-error"></i>
                        <span>All keywords and ranking data</span>
                    </li>
                    <li class="flex items-center gap-2">
                        <i class="fas fa-times-circle text-error"></i>
                        <span>All site audits and reports</span>
                    </li>
                    <li class="flex items-center gap-2">
                        <i class="fas fa-times-circle text-error"></i>
                        <span>All competitor tracking data</span>
                    </li>
                    <li class="flex items-center gap-2">
                        <i class="fas fa-times-circle text-error"></i>
                        <span>All scheduled tasks and reports</span>
                    </li>
                </ul>
            </div>
            
            <div class="form-control">
                <label class="label">
                    <span class="label-text font-semibold">Type <span class="text-error">"confirm"</span> to delete this project:</span>
                </label>
                <input 
                    type="text" 
                    id="delete-confirmation-input"
                    class="input input-bordered" 
                    placeholder="Type 'confirm' here"
                    oninput="validateDeleteConfirmation()"
                    autocomplete="off"
                />
                <label class="label">
                    <span class="label-text-alt text-error" id="delete-input-error"></span>
                </label>
            </div>
        </div>
        
        <!-- Modal Actions -->
        <div class="modal-action">
            <form method="dialog">
                <button class="btn btn-ghost">Cancel</button>
            </form>
            <button 
                id="confirm-delete-btn"
                class="btn btn-error" 
                disabled
                onclick="confirmDeleteProject()"
            >
                <i class="fas fa-trash mr-2"></i>
                Delete Project
            </button>
        </div>
    </div>
    
    <!-- Click outside to close -->
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>
{% endblock %}